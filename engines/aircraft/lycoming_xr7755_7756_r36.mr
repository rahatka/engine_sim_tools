// Engine Sim V0.1.14A
// Lycoming XR-7755
// Created by oror 2023

// bank 2
// stroke=171.458 mm Δstroke=0.008 mm
// TDC at 40.435°, Δσ=0.435°, ΔTDC=0.445 mm, CR=8.649
// CR-optimal params: L1=283.717 or R1=75.746 or ψ=40.000°
// bank 40.000°, avg-optimized ψ=44.42°, artic TDC=48.835°
// ΔVolume=0.004%, ΔCR=1.755%

// bank 3
// stroke=171.692 mm Δstroke=0.242 mm
// TDC at 82.435°, Δσ=2.435°, ΔTDC=-1.024 mm, CR=8.189
// CR-optimal params: L1=285.153 or R1=77.233 or ψ=82.168°
// bank 80.000°, avg-optimized ψ=86.80°, artic TDC=93.610°
// ΔVolume=0.141%, ΔCR=-3.664%

// bank 4
// stroke=172.121 mm Δstroke=0.671 mm
// TDC at 123.579°, Δσ=3.579°, ΔTDC=-0.275 mm, CR=8.440
// CR-optimal params: L1=284.347 or R1=76.390 or ψ=120.462°
// bank 120.000°, avg-optimized ψ=125.97°, artic TDC=131.942°
// ΔVolume=0.391%, ΔCR=-0.707%

// bank 5
// stroke=171.649 mm Δstroke=0.199 mm
// TDC at 161.658°, Δσ=1.658°, ΔTDC=1.317 mm, CR=8.968
// CR-optimal params: L1=282.818 or R1=74.853 or ψ=160.000°
// bank 160.000°, avg-optimized ψ=162.34°, artic TDC=164.688°
// ΔVolume=0.116%, ΔCR=5.502%

// bank 6
// stroke=171.649 mm Δstroke=0.199 mm
// TDC at 198.342°, Δσ=-1.658°, ΔTDC=1.317 mm, CR=8.968
// CR-optimal params: L1=282.818 or R1=74.853 or ψ=200.000°
// bank 200.000°, avg-optimized ψ=197.66°, artic TDC=195.312°
// ΔVolume=0.116%, ΔCR=5.502%

// bank 7
// stroke=172.121 mm Δstroke=0.671 mm
// TDC at 236.421°, Δσ=-3.579°, ΔTDC=-0.275 mm, CR=8.440
// CR-optimal params: L1=284.347 or R1=76.390 or ψ=239.538°
// bank 240.000°, avg-optimized ψ=234.03°, artic TDC=228.058°
// ΔVolume=0.391%, ΔCR=-0.707%

// bank 8
// stroke=171.692 mm Δstroke=0.242 mm
// TDC at 277.565°, Δσ=-2.435°, ΔTDC=-1.024 mm, CR=8.189
// CR-optimal params: L1=285.153 or R1=77.233 or ψ=277.832°
// bank 280.000°, avg-optimized ψ=273.20°, artic TDC=266.390°
// ΔVolume=0.141%, ΔCR=-3.664%

// bank 9
// stroke=171.458 mm Δstroke=0.008 mm
// TDC at 319.565°, Δσ=-0.435°, ΔTDC=0.445 mm, CR=8.649
// CR-optimal params: L1=283.717 or R1=75.746 or ψ=320.000°
// bank 320.000°, avg-optimized ψ=315.58°, artic TDC=311.165°
// ΔVolume=0.004%, ΔCR=1.755%

// CR-optimal R1 avg 76.055
// CR-optimal L1 avg 284.009

// actual displacement: 127.288 L 7767.59 CI avg CR: 8.555

/*
{
  "artic_cfg": {
    "chamber_volumes": [
      470.754,
      461.594,
      491.844,
      476.414,
      443.637,
      443.637,
      476.414,
      491.844,
      461.594
    ],
    "comp_R1": [
      75.746,
      77.233,
      76.39,
      74.853,
      74.853,
      76.39,
      77.233,
      75.746
    ],
    "comp_ign": [
      0.435,
      2.435,
      3.579,
      1.658,
      -1.658,
      -3.579,
      -2.435,
      -0.435
    ],
    "cyl_per_bank": 4,
    "num_of_banks": 9,
    "psi": null,
    "sigma": null
  },
  "cam_cfg": {
    "equal_base_radius": false,
    "exhaust_at_lift": 0.254,
    "exhaust_base_mult": 2.0,
    "exhaust_cos": false,
    "exhaust_sigma": 3.0,
    "exhaust_trim": 0.65,
    "exhaust_volume": 0.5,
    "intake_at_lift": 0.254,
    "intake_base_mult": 2.0,
    "intake_cos": false,
    "intake_sigma": 3.0,
    "intake_trim": 0.65,
    "intake_volume": 0.5,
    "lift_significant_fraction": 250.0,
    "ramp_position": 0.0,
    "ramp_steepness": 0.0,
    "resolution": 64,
    "roller_tappet_radius": 0.7
  },
  "engine": {
    "catalog_id": 544,
    "description": [
      "The XR-7755-3 is the largest, most powerful reciprocating aircraft engine in the world.",
      "During World War II, the U.S. Army Air Forces requested an engine with high takeoff power and low fuel consumption for a yet-to-be designed long-range bomber and transport.",
      "Lycoming began designing the engine in early 1944, and it was ready for testing by mid-1946.",
      "It featured nine dual-lobe overhead camshafts, which shifted axially for takeoff and cruising efficiency, and a two-speed, geared, dual-rotation propeller drive.",
      "Lycoming built two XR 7755-3 prototypes. The company and the Army successfully tested them, but neither engine ever flew in an airframe.",
      "The proven reliability of the new gas turbine engines introduced after World War II made the XR 7755-3 obsolete before it could be fully developed. This artifact is the sole survivor.",
      "Source https://airandspace.si.edu/collection-objects/lycoming-xr-7755-3-radial-36-engine/nasm_A19781379000"
    ],
    "enable_update": true,
    "es_version": "V0.1.14A",
    "name": "Lycoming XR-7755 R-36 1946 NA version",
    "yt_handle": null
  },
  "flow_cfg": {
    "collector_area_coeff": 0.5,
    "exhaust_flange_dia": null,
    "exhaust_port_dia": null,
    "exhaust_stem_dia": 19.05,
    "intake_port_dia": null,
    "intake_runner_dia_mult": 1.0,
    "intake_stem_dia": 19.05,
    "ir_to_er_ratio": 3.0,
    "max_power_rpm": 2500.0,
    "max_torque_rpm": 1600.0,
    "port_to_valve_area": 0.81,
    "power_factor": 1.15,
    "primary_area_coeff": 1.0,
    "resolution": 32,
    "smoothness": 2.0,
    "valve_to_stem_dia": 4.9
  },
  "ign_cfg": {
    "end_deg": 24,
    "end_rpm": 2500,
    "exp_mode": 2,
    "flywheel": 5,
    "resolution": 16,
    "start_rpm": 200
  }
}
*/

import "engine_sim.mr"
import "../../fuel/30.mr"

units units()
constants constants()

label bore(161.925) // 6 3/8
label stroke(171.45) // 6 3/4
label compression_ratio(8.5)
label con_rod(358.775) // 14 1/8 [J.G. Blackwood Notes. RG 342 RD2311 XR-7755, 1943-1948: 503-602 Engineering Data.]
label L1(284.162) // ? 11 3/16
label R1(76.2) // 3 ?
label psi0(40.0 * units.deg)
label psi1(80.0 * units.deg)
label psi2(120.0 * units.deg)
label psi3(160.0 * units.deg)
label psi4(200.0 * units.deg)
label psi5(240.0 * units.deg)
label psi6(280.0 * units.deg)
label psi7(320.0 * units.deg)
label compression_height(bore / 2 * units.mm) // ?
label intake_valve_diameter(82.55) // 3 1/4 ; 3/4 stem
label exhaust_valve_diameter(82.55) // 3 1/4 ? ; 3/4 stem
label intake_valves(1.0)
label exhaust_valves(1.0)

label cyl(36.0)
label row(9.0)
label cyl_base(cyl / row)
label cycle(720.0 * units.deg)
label vee(40.0 * units.deg)
label rot(cycle / cyl)
label rot_base(cycle / cyl_base)
label rot90(90.0 * units.deg)
label rot180(180.0 * units.deg)
label rot360(360.0 * units.deg)

label redline(2650.0) // RPM

// Lycoming O-1230 timing
label IVL(17.4625) // ? 11/16
label EVL(17.4625) // ? 11/16
label IVO(31.0 * units.deg) //BTDC
label IVC(67.0 * units.deg) //ABDC
label EVO(61.0 * units.deg) //BBDC
label EVC(37.0 * units.deg) //ATDC

label ILC((rot180 - IVO + IVC) / 2.0 + rot360)
label ELC((rot180 - EVO + EVC) / 2.0 + rot180)

label con_rod_mass(2500.0) // ? g
label crank_mass(120.0) // ? kg
label flywheel_mass(70.0) // kg

label exhaust_delay_coeff(1.5)

public node intake_lobe_profile {
    // lobes.py v1.0 | 278.0 278.0 LSA 105.00 ADV -3.00 OVL 68.0
    alias output __out: _lobe_profile;
    function _lobe_profile(2.458 * units.deg)
        _lobe_profile
        .add_sample(-76.210 * units.deg, 0.000 * units.mm)
        .add_sample(-73.751 * units.deg, 0.073 * units.mm)
        .add_sample(-71.293 * units.deg, 0.216 * units.mm)
        .add_sample(-68.835 * units.deg, 0.397 * units.mm)
        .add_sample(-66.376 * units.deg, 0.610 * units.mm)
        .add_sample(-63.918 * units.deg, 0.879 * units.mm)
        .add_sample(-61.459 * units.deg, 1.178 * units.mm)
        .add_sample(-59.001 * units.deg, 1.508 * units.mm)
        .add_sample(-56.543 * units.deg, 1.872 * units.mm)
        .add_sample(-54.084 * units.deg, 2.272 * units.mm)
        .add_sample(-51.626 * units.deg, 2.742 * units.mm)
        .add_sample(-49.168 * units.deg, 3.267 * units.mm)
        .add_sample(-46.709 * units.deg, 3.844 * units.mm)
        .add_sample(-44.251 * units.deg, 4.480 * units.mm)
        .add_sample(-41.792 * units.deg, 5.210 * units.mm)
        .add_sample(-39.334 * units.deg, 6.027 * units.mm)
        .add_sample(-36.876 * units.deg, 6.916 * units.mm)
        .add_sample(-34.417 * units.deg, 7.875 * units.mm)
        .add_sample(-31.959 * units.deg, 8.892 * units.mm)
        .add_sample(-29.501 * units.deg, 9.942 * units.mm)
        .add_sample(-27.042 * units.deg, 10.988 * units.mm)
        .add_sample(-24.584 * units.deg, 11.982 * units.mm)
        .add_sample(-22.125 * units.deg, 12.954 * units.mm)
        .add_sample(-19.667 * units.deg, 13.880 * units.mm)
        .add_sample(-17.209 * units.deg, 14.658 * units.mm)
        .add_sample(-14.750 * units.deg, 15.389 * units.mm)
        .add_sample(-12.292 * units.deg, 16.009 * units.mm)
        .add_sample(-9.834 * units.deg, 16.453 * units.mm)
        .add_sample(-7.375 * units.deg, 16.900 * units.mm)
        .add_sample(-4.917 * units.deg, 17.179 * units.mm)
        .add_sample(-2.458 * units.deg, 17.330 * units.mm)
        .add_sample(0.000 * units.deg, 17.462 * units.mm)
        .add_sample(2.458 * units.deg, 17.330 * units.mm)
        .add_sample(4.917 * units.deg, 17.179 * units.mm)
        .add_sample(7.375 * units.deg, 16.900 * units.mm)
        .add_sample(9.834 * units.deg, 16.453 * units.mm)
        .add_sample(12.292 * units.deg, 16.009 * units.mm)
        .add_sample(14.750 * units.deg, 15.389 * units.mm)
        .add_sample(17.209 * units.deg, 14.658 * units.mm)
        .add_sample(19.667 * units.deg, 13.880 * units.mm)
        .add_sample(22.125 * units.deg, 12.954 * units.mm)
        .add_sample(24.584 * units.deg, 11.982 * units.mm)
        .add_sample(27.042 * units.deg, 10.988 * units.mm)
        .add_sample(29.501 * units.deg, 9.942 * units.mm)
        .add_sample(31.959 * units.deg, 8.892 * units.mm)
        .add_sample(34.417 * units.deg, 7.875 * units.mm)
        .add_sample(36.876 * units.deg, 6.916 * units.mm)
        .add_sample(39.334 * units.deg, 6.027 * units.mm)
        .add_sample(41.792 * units.deg, 5.210 * units.mm)
        .add_sample(44.251 * units.deg, 4.480 * units.mm)
        .add_sample(46.709 * units.deg, 3.844 * units.mm)
        .add_sample(49.168 * units.deg, 3.267 * units.mm)
        .add_sample(51.626 * units.deg, 2.742 * units.mm)
        .add_sample(54.084 * units.deg, 2.272 * units.mm)
        .add_sample(56.543 * units.deg, 1.872 * units.mm)
        .add_sample(59.001 * units.deg, 1.508 * units.mm)
        .add_sample(61.459 * units.deg, 1.178 * units.mm)
        .add_sample(63.918 * units.deg, 0.879 * units.mm)
        .add_sample(66.376 * units.deg, 0.610 * units.mm)
        .add_sample(68.835 * units.deg, 0.397 * units.mm)
        .add_sample(71.293 * units.deg, 0.216 * units.mm)
        .add_sample(73.751 * units.deg, 0.073 * units.mm)
        .add_sample(76.210 * units.deg, 0.000 * units.mm)
}

public node exhaust_lobe_profile {
    // lobes.py v1.0 | 278.0 278.0 LSA 105.00 ADV -3.00 OVL 68.0
    alias output __out: _lobe_profile;
    function _lobe_profile(2.458 * units.deg)
        _lobe_profile
        .add_sample(-76.210 * units.deg, 0.000 * units.mm)
        .add_sample(-73.751 * units.deg, 0.073 * units.mm)
        .add_sample(-71.293 * units.deg, 0.216 * units.mm)
        .add_sample(-68.835 * units.deg, 0.397 * units.mm)
        .add_sample(-66.376 * units.deg, 0.610 * units.mm)
        .add_sample(-63.918 * units.deg, 0.879 * units.mm)
        .add_sample(-61.459 * units.deg, 1.178 * units.mm)
        .add_sample(-59.001 * units.deg, 1.508 * units.mm)
        .add_sample(-56.543 * units.deg, 1.872 * units.mm)
        .add_sample(-54.084 * units.deg, 2.272 * units.mm)
        .add_sample(-51.626 * units.deg, 2.742 * units.mm)
        .add_sample(-49.168 * units.deg, 3.267 * units.mm)
        .add_sample(-46.709 * units.deg, 3.844 * units.mm)
        .add_sample(-44.251 * units.deg, 4.480 * units.mm)
        .add_sample(-41.792 * units.deg, 5.210 * units.mm)
        .add_sample(-39.334 * units.deg, 6.027 * units.mm)
        .add_sample(-36.876 * units.deg, 6.916 * units.mm)
        .add_sample(-34.417 * units.deg, 7.875 * units.mm)
        .add_sample(-31.959 * units.deg, 8.892 * units.mm)
        .add_sample(-29.501 * units.deg, 9.942 * units.mm)
        .add_sample(-27.042 * units.deg, 10.988 * units.mm)
        .add_sample(-24.584 * units.deg, 11.982 * units.mm)
        .add_sample(-22.125 * units.deg, 12.954 * units.mm)
        .add_sample(-19.667 * units.deg, 13.880 * units.mm)
        .add_sample(-17.209 * units.deg, 14.658 * units.mm)
        .add_sample(-14.750 * units.deg, 15.389 * units.mm)
        .add_sample(-12.292 * units.deg, 16.009 * units.mm)
        .add_sample(-9.834 * units.deg, 16.453 * units.mm)
        .add_sample(-7.375 * units.deg, 16.900 * units.mm)
        .add_sample(-4.917 * units.deg, 17.179 * units.mm)
        .add_sample(-2.458 * units.deg, 17.330 * units.mm)
        .add_sample(0.000 * units.deg, 17.462 * units.mm)
        .add_sample(2.458 * units.deg, 17.330 * units.mm)
        .add_sample(4.917 * units.deg, 17.179 * units.mm)
        .add_sample(7.375 * units.deg, 16.900 * units.mm)
        .add_sample(9.834 * units.deg, 16.453 * units.mm)
        .add_sample(12.292 * units.deg, 16.009 * units.mm)
        .add_sample(14.750 * units.deg, 15.389 * units.mm)
        .add_sample(17.209 * units.deg, 14.658 * units.mm)
        .add_sample(19.667 * units.deg, 13.880 * units.mm)
        .add_sample(22.125 * units.deg, 12.954 * units.mm)
        .add_sample(24.584 * units.deg, 11.982 * units.mm)
        .add_sample(27.042 * units.deg, 10.988 * units.mm)
        .add_sample(29.501 * units.deg, 9.942 * units.mm)
        .add_sample(31.959 * units.deg, 8.892 * units.mm)
        .add_sample(34.417 * units.deg, 7.875 * units.mm)
        .add_sample(36.876 * units.deg, 6.916 * units.mm)
        .add_sample(39.334 * units.deg, 6.027 * units.mm)
        .add_sample(41.792 * units.deg, 5.210 * units.mm)
        .add_sample(44.251 * units.deg, 4.480 * units.mm)
        .add_sample(46.709 * units.deg, 3.844 * units.mm)
        .add_sample(49.168 * units.deg, 3.267 * units.mm)
        .add_sample(51.626 * units.deg, 2.742 * units.mm)
        .add_sample(54.084 * units.deg, 2.272 * units.mm)
        .add_sample(56.543 * units.deg, 1.872 * units.mm)
        .add_sample(59.001 * units.deg, 1.508 * units.mm)
        .add_sample(61.459 * units.deg, 1.178 * units.mm)
        .add_sample(63.918 * units.deg, 0.879 * units.mm)
        .add_sample(66.376 * units.deg, 0.610 * units.mm)
        .add_sample(68.835 * units.deg, 0.397 * units.mm)
        .add_sample(71.293 * units.deg, 0.216 * units.mm)
        .add_sample(73.751 * units.deg, 0.073 * units.mm)
        .add_sample(76.210 * units.deg, 0.000 * units.mm)
}

public node intake_flow {
    alias output __out: _intake_flow;
    function _intake_flow(0.563 * units.mm)
    _intake_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.563, 33.3)
        .add_flow_sample(1.127, 65.3)
        .add_flow_sample(1.690, 95.1)
        .add_flow_sample(2.253, 122.6)
        .add_flow_sample(2.817, 148.0)
        .add_flow_sample(3.380, 171.9)
        .add_flow_sample(3.943, 194.5)
        .add_flow_sample(4.506, 216.2)
        .add_flow_sample(5.070, 236.9)
        .add_flow_sample(5.633, 257.0)
        .add_flow_sample(6.196, 276.4)
        .add_flow_sample(6.760, 295.2)
        .add_flow_sample(7.323, 313.4)
        .add_flow_sample(7.886, 331.2)
        .add_flow_sample(8.450, 348.5)
        .add_flow_sample(9.013, 365.4)
        .add_flow_sample(9.576, 381.8)
        .add_flow_sample(10.140, 397.9)
        .add_flow_sample(10.703, 413.7)
        .add_flow_sample(11.266, 429.1)
        .add_flow_sample(11.829, 444.2)
        .add_flow_sample(12.393, 459.0)
        .add_flow_sample(12.956, 473.5)
        .add_flow_sample(13.519, 487.8)
        .add_flow_sample(14.083, 501.7)
        .add_flow_sample(14.646, 515.5)
        .add_flow_sample(15.209, 529.0)
        .add_flow_sample(15.773, 542.3)
        .add_flow_sample(16.336, 555.5)
        .add_flow_sample(16.899, 568.6)
        .add_flow_sample(17.462, 581.7)
}

public node exhaust_flow {
    alias output __out: _exhaust_flow;
    function _exhaust_flow(0.563 * units.mm)
    _exhaust_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.563, 38.9)
        .add_flow_sample(1.127, 76.2)
        .add_flow_sample(1.690, 110.9)
        .add_flow_sample(2.253, 143.0)
        .add_flow_sample(2.817, 172.7)
        .add_flow_sample(3.380, 200.6)
        .add_flow_sample(3.943, 227.0)
        .add_flow_sample(4.506, 252.2)
        .add_flow_sample(5.070, 276.4)
        .add_flow_sample(5.633, 299.8)
        .add_flow_sample(6.196, 322.4)
        .add_flow_sample(6.760, 344.4)
        .add_flow_sample(7.323, 365.7)
        .add_flow_sample(7.886, 386.4)
        .add_flow_sample(8.450, 406.6)
        .add_flow_sample(9.013, 426.2)
        .add_flow_sample(9.576, 445.5)
        .add_flow_sample(10.140, 464.3)
        .add_flow_sample(10.703, 482.6)
        .add_flow_sample(11.266, 500.6)
        .add_flow_sample(11.829, 518.2)
        .add_flow_sample(12.393, 535.5)
        .add_flow_sample(12.956, 552.4)
        .add_flow_sample(13.519, 569.1)
        .add_flow_sample(14.083, 585.4)
        .add_flow_sample(14.646, 601.4)
        .add_flow_sample(15.209, 617.2)
        .add_flow_sample(15.773, 632.7)
        .add_flow_sample(16.336, 648.1)
        .add_flow_sample(16.899, 663.4)
        .add_flow_sample(17.462, 678.6)
}

intake_lobe_profile intake_lobe_profile()
exhaust_lobe_profile exhaust_lobe_profile()

intake_flow intake_flow()
exhaust_flow exhaust_flow()

private node add_lobes {
    input base;
    input shift: 0.0;
    input this;
    alias output __out: this;

    this.add_lobe(base + 0 * rot * row + shift)
    this.add_lobe(base + 1 * rot * row + shift)
    this.add_lobe(base + 2 * rot * row + shift)
    this.add_lobe(base + 3 * rot * row + shift)
}

public node bank_builder {
    input shift;
    input chamber_volume;
    input rods;
    input piston_params;
    input cr_params;
    input bank_params;
    input intake;
    input exhaust;

    input pl0;
    input pl1;
    input pl2;
    input pl3;

    output wire1: _wire1;
    output wire2: _wire2;
    output wire3: _wire3;
    output wire4: _wire4;

    output b0: _b0;

    ignition_wire _wire1()
    ignition_wire _wire2()
    ignition_wire _wire3()
    ignition_wire _wire4()

    camshaft _intake_cam_0(base_radius: 34.9 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_0(base_radius: 34.9 * units.mm, lobe_profile: exhaust_lobe_profile)

    _intake_cam_0.add_lobes(ILC, -shift)
    _exhaust_cam_0.add_lobes(ELC, -shift)

    cylinder_bank _b0(bank_params, angle: shift)

    _b0.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: rods.cr0,
            rod_journal: rods.rj0,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl0,
            ignition_wire: _wire1
        )
    _b0.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: rods.cr1,
            rod_journal: rods.rj1,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl1,
            ignition_wire: _wire2
        )
    _b0.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: rods.cr2,
            rod_journal: rods.rj2,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl2,
            ignition_wire: _wire3
        )
    _b0.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: rods.cr3,
            rod_journal: rods.rj3,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl3,
            ignition_wire: _wire4
        )

    _b0.set_cylinder_head(
        head(
            chamber_volume: chamber_volume,
            intake_camshaft: _intake_cam_0,
            exhaust_camshaft: _exhaust_cam_0
        )
    )
}

private node add_flow_sample {
    input lift;
    input flow;
    input this;
    alias output __out: this;

    this.add_sample(lift * units.mm, k_28inH2O(flow))
}

public node head {
    // port_flow.py v1.7
    // intake port area: 40.5 cm²; saturated lift: 17.35 mm
    // exhaust port area: 40.5 cm²; saturated lift: 17.35 mm
    // cylinder volume: 3530.7 cm³ (215.45 CI); engine volume: 127.104 L (7756.33 CI)
    // chamber volume: 470.8 cm³ (28.73 CI); conrod/stroke 2.093; N.A.C.C. 585.23
    // 32 harmonic intake runner length: 16.6 cm; diameter: 7.1 cm
    // primary length: 49.3 cm, area: 40.5 cm², diameter: 7.2 cm
    // collector diameter: 30.5 cm, area: 729.0 cm²

    input chamber_volume;
    input intake_camshaft;
    input exhaust_camshaft;
    input flip_display: false;
    
    alias output __out: head;
    generic_cylinder_head head(
        chamber_volume: chamber_volume * units.cc,
        intake_runner_volume: 655.7 * units.cc,
        intake_runner_cross_section_area: 39.4 * units.cm2,
        exhaust_runner_volume: 218.6 * units.cc,
        exhaust_runner_cross_section_area: 40.5 * units.cm2,

        intake_port_flow: intake_flow,
        exhaust_port_flow: exhaust_flow,
        valvetrain: standard_valvetrain(
            intake_camshaft: intake_camshaft,
            exhaust_camshaft: exhaust_camshaft
        ),
        flip_display: flip_display
    )
}

private node add_wires {
    input bank;
    input phasing: 0.0;
    input this;
    alias output __out: this;

    this.connect_wire(bank.wire1, rot_base * 0 + phasing)
    this.connect_wire(bank.wire2, rot_base * 1 + phasing)
    this.connect_wire(bank.wire3, rot_base * 2 + phasing)
    this.connect_wire(bank.wire4, rot_base * 3 + phasing)
}

public node rods {
    input rj0; input rj1; input rj2; input rj3;

    output cr0_0: mcr0; output cr1_0: mcr1; output cr2_0: mcr2; output cr3_0: mcr3;
    output rj0_0: rj0; output rj1_0: rj1; output rj2_0: rj2; output rj3_0: rj3;

    output rj0_1: sj0_0; output rj1_1: sj1_0; output rj2_1: sj2_0; output rj3_1: sj3_0;
    output cr0_1: sr0_0; output cr1_1: sr1_0; output cr2_1: sr2_0; output cr3_1: sr3_0;

    output cr0_2: sr0_1; output cr1_2: sr1_1; output cr2_2: sr2_1; output cr3_2: sr3_1;
    output rj0_2: sj0_1; output rj1_2: sj1_1; output rj2_2: sj2_1; output rj3_2: sj3_1;

    output cr0_3: sr0_2; output cr1_3: sr1_2; output cr2_3: sr2_2; output cr3_3: sr3_2;
    output rj0_3: sj0_2; output rj1_3: sj1_2; output rj2_3: sj2_2; output rj3_3: sj3_2;

    output cr0_4: sr0_3; output cr1_4: sr1_3; output cr2_4: sr2_3; output cr3_4: sr3_3;
    output rj0_4: sj0_3; output rj1_4: sj1_3; output rj2_4: sj2_3; output rj3_4: sj3_3;

    output cr0_5: sr0_4; output cr1_5: sr1_4; output cr2_5: sr2_4; output cr3_5: sr3_4;
    output rj0_5: sj0_4; output rj1_5: sj1_4; output rj2_5: sj2_4; output rj3_5: sj3_4;

    output cr0_6: sr0_5; output cr1_6: sr1_5; output cr2_6: sr2_5; output cr3_6: sr3_5;
    output rj0_6: sj0_5; output rj1_6: sj1_5; output rj2_6: sj2_5; output rj3_6: sj3_5;

    output cr0_7: sr0_6; output cr1_7: sr1_6; output cr2_7: sr2_6; output cr3_7: sr3_6;
    output rj0_7: sj0_6; output rj1_7: sj1_6; output rj2_7: sj2_6; output rj3_7: sj3_6;

    output cr0_8: sr0_7; output cr1_8: sr1_7; output cr2_8: sr2_7; output cr3_8: sr3_7;
    output rj0_8: sj0_7; output rj1_8: sj1_7; output rj2_8: sj2_7; output rj3_8: sj3_7;

    connecting_rod_parameters master_rod_params(
        mass: con_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: con_rod_mass * units.g,
            length: con_rod * units.mm
        ),
        slave_throw: R1 * units.mm,
        center_of_mass: 0.0,
        length: con_rod * units.mm
    )

    label slave_rod_mass(850)
    connecting_rod_parameters slave_rod_params(
        mass: slave_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: slave_rod_mass * units.g,
            length: L1 * units.mm
        ),
        center_of_mass: 0.0,
        length: L1 * units.mm
    )

    connecting_rod mcr0(master_rod_params)
    connecting_rod mcr1(master_rod_params)
    connecting_rod mcr2(master_rod_params)
    connecting_rod mcr3(master_rod_params)

    connecting_rod sr0_0(slave_rod_params)
    connecting_rod sr1_0(slave_rod_params)
    connecting_rod sr2_0(slave_rod_params)
    connecting_rod sr3_0(slave_rod_params)

    connecting_rod sr0_1(slave_rod_params)
    connecting_rod sr1_1(slave_rod_params)
    connecting_rod sr2_1(slave_rod_params)
    connecting_rod sr3_1(slave_rod_params)

    connecting_rod sr0_2(slave_rod_params)
    connecting_rod sr1_2(slave_rod_params)
    connecting_rod sr2_2(slave_rod_params)
    connecting_rod sr3_2(slave_rod_params)

    connecting_rod sr0_3(slave_rod_params)
    connecting_rod sr1_3(slave_rod_params)
    connecting_rod sr2_3(slave_rod_params)
    connecting_rod sr3_3(slave_rod_params)

    connecting_rod sr0_4(slave_rod_params)
    connecting_rod sr1_4(slave_rod_params)
    connecting_rod sr2_4(slave_rod_params)
    connecting_rod sr3_4(slave_rod_params)

    connecting_rod sr0_5(slave_rod_params)
    connecting_rod sr1_5(slave_rod_params)
    connecting_rod sr2_5(slave_rod_params)
    connecting_rod sr3_5(slave_rod_params)

    connecting_rod sr0_6(slave_rod_params)
    connecting_rod sr1_6(slave_rod_params)
    connecting_rod sr2_6(slave_rod_params)
    connecting_rod sr3_6(slave_rod_params)

    connecting_rod sr0_7(slave_rod_params)
    connecting_rod sr1_7(slave_rod_params)
    connecting_rod sr2_7(slave_rod_params)
    connecting_rod sr3_7(slave_rod_params)

    rod_journal sj0_0(angle: psi0)
    rod_journal sj1_0(angle: psi0)
    rod_journal sj2_0(angle: psi0)
    rod_journal sj3_0(angle: psi0)

    rod_journal sj0_1(angle: psi1)
    rod_journal sj1_1(angle: psi1)
    rod_journal sj2_1(angle: psi1)
    rod_journal sj3_1(angle: psi1)

    rod_journal sj0_2(angle: psi2)
    rod_journal sj1_2(angle: psi2)
    rod_journal sj2_2(angle: psi2)
    rod_journal sj3_2(angle: psi2)

    rod_journal sj0_3(angle: psi3)
    rod_journal sj1_3(angle: psi3)
    rod_journal sj2_3(angle: psi3)
    rod_journal sj3_3(angle: psi3)

    rod_journal sj0_4(angle: psi4)
    rod_journal sj1_4(angle: psi4)
    rod_journal sj2_4(angle: psi4)
    rod_journal sj3_4(angle: psi4)

    rod_journal sj0_5(angle: psi5)
    rod_journal sj1_5(angle: psi5)
    rod_journal sj2_5(angle: psi5)
    rod_journal sj3_5(angle: psi5)

    rod_journal sj0_6(angle: psi6)
    rod_journal sj1_6(angle: psi6)
    rod_journal sj2_6(angle: psi6)
    rod_journal sj3_6(angle: psi6)

    rod_journal sj0_7(angle: psi7)
    rod_journal sj1_7(angle: psi7)
    rod_journal sj2_7(angle: psi7)
    rod_journal sj3_7(angle: psi7)

    mcr0.add_slave_journal(sj0_0)
    mcr1.add_slave_journal(sj1_0)
    mcr2.add_slave_journal(sj2_0)
    mcr3.add_slave_journal(sj3_0)

    mcr0.add_slave_journal(sj0_1)
    mcr1.add_slave_journal(sj1_1)
    mcr2.add_slave_journal(sj2_1)
    mcr3.add_slave_journal(sj3_1)

    mcr0.add_slave_journal(sj0_2)
    mcr1.add_slave_journal(sj1_2)
    mcr2.add_slave_journal(sj2_2)
    mcr3.add_slave_journal(sj3_2)

    mcr0.add_slave_journal(sj0_3)
    mcr1.add_slave_journal(sj1_3)
    mcr2.add_slave_journal(sj2_3)
    mcr3.add_slave_journal(sj3_3)

    mcr0.add_slave_journal(sj0_4)
    mcr1.add_slave_journal(sj1_4)
    mcr2.add_slave_journal(sj2_4)
    mcr3.add_slave_journal(sj3_4)

    mcr0.add_slave_journal(sj0_5)
    mcr1.add_slave_journal(sj1_5)
    mcr2.add_slave_journal(sj2_5)
    mcr3.add_slave_journal(sj3_5)

    mcr0.add_slave_journal(sj0_6)
    mcr1.add_slave_journal(sj1_6)
    mcr2.add_slave_journal(sj2_6)
    mcr3.add_slave_journal(sj3_6)

    mcr0.add_slave_journal(sj0_7)
    mcr1.add_slave_journal(sj1_7)
    mcr2.add_slave_journal(sj2_7)
    mcr3.add_slave_journal(sj3_7)
}

public node r0 {
    input rods;
    output cr0: rods.cr0_0;
    output cr1: rods.cr1_0;
    output cr2: rods.cr2_0;
    output cr3: rods.cr3_0;
    output rj0: rods.rj0_0;
    output rj1: rods.rj1_0;
    output rj2: rods.rj2_0;
    output rj3: rods.rj3_0;
}

public node r1 {
    input rods;
    output cr0: rods.cr0_1;
    output cr1: rods.cr1_1;
    output cr2: rods.cr2_1;
    output cr3: rods.cr3_1;
    output rj0: rods.rj0_1;
    output rj1: rods.rj1_1;
    output rj2: rods.rj2_1;
    output rj3: rods.rj3_1;
}

public node r2 {
    input rods;
    output cr0: rods.cr0_2;
    output cr1: rods.cr1_2;
    output cr2: rods.cr2_2;
    output cr3: rods.cr3_2;
    output rj0: rods.rj0_2;
    output rj1: rods.rj1_2;
    output rj2: rods.rj2_2;
    output rj3: rods.rj3_2;
}

public node r3 {
    input rods;
    output cr0: rods.cr0_3;
    output cr1: rods.cr1_3;
    output cr2: rods.cr2_3;
    output cr3: rods.cr3_3;
    output rj0: rods.rj0_3;
    output rj1: rods.rj1_3;
    output rj2: rods.rj2_3;
    output rj3: rods.rj3_3;
}

public node r4 {
    input rods;
    output cr0: rods.cr0_4;
    output cr1: rods.cr1_4;
    output cr2: rods.cr2_4;
    output cr3: rods.cr3_4;
    output rj0: rods.rj0_4;
    output rj1: rods.rj1_4;
    output rj2: rods.rj2_4;
    output rj3: rods.rj3_4;
}

public node r5 {
    input rods;
    output cr0: rods.cr0_5;
    output cr1: rods.cr1_5;
    output cr2: rods.cr2_5;
    output cr3: rods.cr3_5;
    output rj0: rods.rj0_5;
    output rj1: rods.rj1_5;
    output rj2: rods.rj2_5;
    output rj3: rods.rj3_5;
}

public node r6 {
    input rods;
    output cr0: rods.cr0_6;
    output cr1: rods.cr1_6;
    output cr2: rods.cr2_6;
    output cr3: rods.cr3_6;
    output rj0: rods.rj0_6;
    output rj1: rods.rj1_6;
    output rj2: rods.rj2_6;
    output rj3: rods.rj3_6;
}

public node r7 {
    input rods;
    output cr0: rods.cr0_7;
    output cr1: rods.cr1_7;
    output cr2: rods.cr2_7;
    output cr3: rods.cr3_7;
    output rj0: rods.rj0_7;
    output rj1: rods.rj1_7;
    output rj2: rods.rj2_7;
    output rj3: rods.rj3_7;
}

public node r8 {
    input rods;
    output cr0: rods.cr0_8;
    output cr1: rods.cr1_8;
    output cr2: rods.cr2_8;
    output cr3: rods.cr3_8;
    output rj0: rods.rj0_8;
    output rj1: rods.rj1_8;
    output rj2: rods.rj2_8;
    output rj3: rods.rj3_8;
}

public node eng {
    alias output __out: engine;

    engine engine(
        name: "Lycoming XR-7755",
        starter_torque: 2000 * units.Nm,
        starter_speed: 150 * units.rpm,
        redline: redline * units.rpm,
        fuel: a30(),
        throttle_gamma: 2.0,
        jitter: 0.7,
        noise: 0.1,
        hf_gain: 0.007,
        fluid_simulation_steps: 4,
        max_sle_solver_steps: 32,
        simulation_frequency: 3000,
        dyno_min_speed: 500 * units.rpm
    )
    
    connecting_rod_parameters cr_params(
        mass: con_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: con_rod_mass * units.g,
            length: con_rod * units.mm
        ),
        center_of_mass: 0.0,
        length: con_rod * units.mm
    )

    label crank_moment(disk_moment_of_inertia(mass: crank_mass * units.kg, radius: (stroke / 2.0) * units.mm))
    label flywheel_moment(disk_moment_of_inertia(mass: flywheel_mass * units.kg, radius: (stroke * 3.5) * units.mm))
    label other_moment(disk_moment_of_inertia(mass: 1 * units.kg, radius: 1.0 * units.cm))

    crankshaft c0(
        throw: (stroke / 2.0) * units.mm,
        flywheel_mass: flywheel_mass * units.kg,
        mass: crank_mass * units.kg,
        friction_torque: 190.7 * units.Nm,
        moment_of_inertia: crank_moment + flywheel_moment + other_moment,
        tdc: 0.0
    )

    rod_journal rj0(angle: (0.0 / cyl * row) * cycle + rot90)
    rod_journal rj1(angle: (1.0 / cyl * row) * cycle + rot90)
    rod_journal rj2(angle: (2.0 / cyl * row) * cycle + rot90)
    rod_journal rj3(angle: (3.0 / cyl * row) * cycle + rot90)

    rods r(rj0, rj1, rj2, rj3)

    bank_builder bank0(
        shift: 0.0 * units.deg,
        chamber_volume: 470.754,
        rods: r0(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh0, pl1 + sh0, pl2 + sh0, pl3 + sh0
    )
    bank_builder bank1(
        shift: vee * 1 + rot360,
        chamber_volume: 461.594,
        rods: r1(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh1, pl1 + sh1, pl2 + sh1, pl3 + sh1
    )
    bank_builder bank2(
        shift: vee * 2,
        chamber_volume: 491.844,
        rods: r2(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh2, pl1 + sh2, pl2 + sh2, pl3 + sh2
    )
    bank_builder bank3(
        shift: vee * 3 + rot360,
        chamber_volume: 476.414,
        rods: r3(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh3, pl1 + sh3, pl2 + sh3, pl3 + sh3
    )
    bank_builder bank4(
        shift: vee * 4,
        chamber_volume: 443.637,
        rods: r4(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh4, pl1 + sh4, pl2 + sh4, pl3 + sh4
    )
    bank_builder bank5(
        shift: vee * 5 + rot360,
        chamber_volume: 443.637,
        rods: r5(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh5, pl1 + sh5, pl2 + sh5, pl3 + sh5
    )
    bank_builder bank6(
        shift: vee * 6,
        chamber_volume: 476.414,
        rods: r6(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh6, pl1 + sh6, pl2 + sh6, pl3 + sh6
    )
    bank_builder bank7(
        shift: vee * 7 + rot360,
        chamber_volume: 491.844,
        rods: r7(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh7, pl1 + sh7, pl2 + sh7, pl3 + sh7
    )
    bank_builder bank8(
        shift: vee * 8,
        chamber_volume: 461.594,
        rods: r8(r),
        piston_params: piston_params,
        cr_params: cr_params,
        bank_params: bank_params,
        intake: intake,
        exhaust: exhaust,
        pl0 + sh8, pl1 + sh8, pl2 + sh8, pl3 + sh8
    )

    ignition_module ignition(timing_curve: timing_curve, rev_limit: redline * 1.5 * units.rpm, limiter_duration: 0.001)
    ignition.add_wires(bank0, -vee * 0)
    ignition.add_wires(bank1, -vee * 1 + rot360)
    ignition.add_wires(bank2, -vee * 2)
    ignition.add_wires(bank3, -vee * 3 + rot360)
    ignition.add_wires(bank4, -vee * 4)
    ignition.add_wires(bank5, -vee * 5 + rot360)
    ignition.add_wires(bank6, -vee * 6)
    ignition.add_wires(bank7, -vee * 7 + rot360)
    ignition.add_wires(bank8, -vee * 8)

    piston_parameters piston_params(
        mass: 1500 * units.g,
        blowby: k_28inH2O(0.051),
        compression_height: compression_height,
        wrist_pin_position: 0.0,
        displacement: 0.0
    )

    cylinder_bank_parameters bank_params(
        bore: bore * units.mm,
        deck_height: (con_rod + stroke / 2.0) * units.mm + compression_height
    )
    
    c0
        .add_rod_journal(rj0)
        .add_rod_journal(rj1)
        .add_rod_journal(rj2)
        .add_rod_journal(rj3)

    label collector_cross_section_area(729.0)

    label exhaust_pipe_length_0(300.0) // cm
    label exhaust_volume_0(collector_cross_section_area * exhaust_pipe_length_0 / 1000.0) // Litres

    intake intake(
        plenum_volume: 51.2 * units.L,
        plenum_cross_section_area: 709.2 * units.cm2,
        runner_length: 16.6 * units.cm,
        intake_flow_rate: k_carb(6034.8),
        idle_flow_rate: k_carb(0.03),
        idle_throttle_plate_position: 0.9975,
        runner_flow_rate: k_carb(360.4),
        velocity_decay: 0.05
    )
    
    exhaust_system_parameters es_params0(
        outlet_flow_rate: k_carb(10435.1),
        collector_cross_section_area: 729.0 * units.cm2,
        length: exhaust_pipe_length_0 * units.cm,
        primary_tube_length: 49.3 * units.cm,
        primary_flow_rate: k_carb(601.5),
        velocity_decay: 0.9,
        volume: exhaust_volume_0 * units.L
    )

    exhaust_system exhaust(es_params0, impulse_response: impulse_response(filename: "../../impulse_responses/smooth_56.wav", volume: 0.001))

    label spacing_factor(1.2)
    label flange_density(1.0 * exhaust_delay_coeff)
    label radial_density(2.0 * exhaust_delay_coeff)

    label sh0 ((1.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh1 ((4.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh2 ((7.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh3 ((10.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh4 ((13.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh5 ((11.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh6 ((8.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh7 ((5.0 * bore * spacing_factor / radial_density) * units.mm)
    label sh8 ((2.0 * bore * spacing_factor / radial_density) * units.mm)
    
    label pl0 ((1.0 * bore * spacing_factor / flange_density) * units.mm)
    label pl1 ((2.0 * bore * spacing_factor / flange_density) * units.mm)
    label pl2 ((3.0 * bore * spacing_factor / flange_density) * units.mm)
    label pl3 ((4.0 * bore * spacing_factor / flange_density) * units.mm)

    engine
        .add_cylinder_bank(bank0.b0)
        .add_cylinder_bank(bank1.b0)
        .add_cylinder_bank(bank2.b0)
        .add_cylinder_bank(bank3.b0)
        .add_cylinder_bank(bank4.b0)
        .add_cylinder_bank(bank5.b0)
        .add_cylinder_bank(bank6.b0)
        .add_cylinder_bank(bank7.b0)
        .add_cylinder_bank(bank8.b0)

    engine.add_crankshaft(c0)

    function timing_curve(176.7 * units.rpm)
    timing_curve
        .add_sample(0.0 * units.rpm, 5.0 * units.deg)
        .add_sample(176.7 * units.rpm, 5.0 * units.deg)
        .add_sample(353.3 * units.rpm, 8.2 * units.deg)
        .add_sample(530.0 * units.rpm, 11.5 * units.deg)
        .add_sample(706.7 * units.rpm, 14.3 * units.deg)
        .add_sample(883.3 * units.rpm, 16.8 * units.deg)
        .add_sample(1060.0 * units.rpm, 19.0 * units.deg)
        .add_sample(1236.7 * units.rpm, 20.9 * units.deg)
        .add_sample(1413.3 * units.rpm, 22.5 * units.deg)
        .add_sample(1590.0 * units.rpm, 24.0 * units.deg)
        .add_sample(1766.7 * units.rpm, 25.2 * units.deg)
        .add_sample(1943.3 * units.rpm, 26.3 * units.deg)
        .add_sample(2120.0 * units.rpm, 27.3 * units.deg)
        .add_sample(2296.7 * units.rpm, 28.2 * units.deg)
        .add_sample(2473.3 * units.rpm, 28.9 * units.deg)
        .add_sample(2650.0 * units.rpm, 29.0 * units.deg)
        .add_sample(2826.7 * units.rpm, -12.5 * units.deg)
        .add_sample(3003.3 * units.rpm, -25.0 * units.deg)

    engine.add_ignition_module(ignition)
}

// Pz V
public node veh {
    alias output __out: vehicle;

    label car_mass(45000) // 45.0 t panther

    vehicle vehicle(
        mass: car_mass * units.kg,
        drag_coefficient: 0.6,
        cross_sectional_area: (2830 * units.mm) * (2680 * units.mm),
        diff_ratio: 2.5 * 5,
        tire_radius: (821.77 / 2) * units.mm,
        rolling_resistance: 0.06 * car_mass * 9.81
        )
}

// Pz V
private node trn {
    alias output __out:
        transmission(
            max_clutch_torque: 15000 * units.Nm,
            max_clutch_flex: 15 * units.deg,
            limit_clutch_flex: true,
            clutch_stiffness: 50 * units.Nm / units.deg,
            clutch_damping: 1.0,
            simulate_flex: true
        )
        .add_gear(10.8)  // 3.7 @ 2600
        .add_gear(5.26)  // 7.6
        .add_gear(3.33)  // 12.0
        .add_gear(2.13)  // 18.8
        .add_gear(1.48)  // 27.0
        .add_gear(1.06)  // 37.7
        .add_gear(0.85); // 47.3
}

run(
    engine: eng(),
    transmission: trn(),
    vehicle: veh()
)
