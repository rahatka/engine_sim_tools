// Engine Sim V0.1.14A
// Pratt & Whitney R-4360 Wasp Major
// actual displacement: 71.653 L 4372.56 CI avg CR: 7.014
// Created by oror 2023

/*
{
  "artic_cfg": {
    "comp_R1": [
      77.605,
      78.334,
      76.141,
      76.141,
      78.334,
      77.605
    ],
    "comp_ign": [
      1.071,
      4.243,
      2.514,
      -2.514,
      -4.243,
      -1.071
    ],
    "cyl_per_bank": 4,
    "num_of_banks": 7,
    "psi": null,
    "sigma": null
  },
  "cam_cfg": {
    "equal_base_radius": false,
    "es_version": "0.1.14a",
    "exhaust_at_lift": 0.0,
    "exhaust_base_mult": 2.0,
    "exhaust_cos": true,
    "exhaust_sigma": 0.5,
    "exhaust_trim": 1.0,
    "exhaust_volume": 0.25,
    "intake_at_lift": 0.0,
    "intake_base_mult": 2.0,
    "intake_cos": true,
    "intake_sigma": 3.9,
    "intake_trim": 1.0,
    "intake_volume": 0.2,
    "lift_significant_fraction": 250.0,
    "ramp_position": 0.0,
    "ramp_steepness": 4.0,
    "resolution": 64,
    "roller_tappet_radius": 0.5
  },
  "engine": {
    "catalog_id": 554,
    "description": [
      "The R-4360 was Pratt & Whitney's last aircraft piston engine, as well as the largest and the most complicated piston engine produced in quantity in the United States.",
      "The 28 cylinders were in four rows of seven cylinders each, arranged in a spiral for better cooling, which contributed to the popular nickname of \"corncob\" applied to all multi-row radial engines.",
      "The R-4360 (known by its commercial designation as the Wasp Major) mainly powered large American military aircraft, including the Boeing C-97, Douglas C-124, and Fairchild C-119 transports and the Boeing B-50 and Consolidated B-36 bombers.",
      "Early versions of the R-4360 produced 2,237 kW (3,000 hp); later models developed 3,207 kW (4,300 hp).",
      "It is believed that Pratt & Whitney crafted this cutaway from a production R-4360 as a teaching tool for military mechanics during World War II.",
      "Source: https://airandspace.si.edu/collection-objects/pratt--whitney-wasp-major-r-4360-59b-cutaway-radial-engine/nasm_A19790005000"
    ],
    "enable_update": true,
    "es_version": "V0.1.14A",
    "name": "Pratt & Whitney R-4360 Wasp Major Radial 28 1944NA version",
    "yt_handle": null
  },
  "flow_cfg": {
    "collector_area_coeff": 0.75,
    "exhaust_flange_dia": null,
    "exhaust_port_dia": null,
    "exhaust_stem_dia": null,
    "intake_port_dia": null,
    "intake_runner_dia_mult": 1.0,
    "intake_stem_dia": null,
    "ir_to_er_ratio": 2.5,
    "max_power_rpm": 2800.0,
    "max_torque_rpm": 1800.0,
    "port_to_valve_area": 0.85,
    "power_factor": 1.25,
    "primary_area_coeff": 1.1,
    "resolution": 32,
    "smoothness": 2.0,
    "valve_to_stem_dia": 4.9
  }
}
*/

import "engine_sim.mr"
import "../../fuel/30.mr"

units units()
constants constants()

label bore(146.05) // 5 3/4
label stroke(152.4) // 6
label compression_ratio(7.0)
label con_rod(312.674) // 12.31 (312.674)
label L1(236.93) // ?
label R1(77.36) // ?
label compression_height(64.0 * units.mm) // ~
label intake_valve_diameter(78.0) // ASh-62
label exhaust_valve_diameter(78.0) // ASh-62
label intake_valves(1.0)
label exhaust_valves(1.0)

label cyl(28.0)
label row(1.0)
label cycle(720.0 * units.deg)
label rot(cycle / cyl)
label rot90(90.0 * units.deg)
label rot180(180.0 * units.deg)
label rot360(360.0 * units.deg)

label redline(2900.0) // RPM

label IVL(12.192) // 0.48 pushrod lift
label EVL(10.668) // 0.42 pushrod lift

// R-4360 valve timings
label IVO(64.0 * units.deg) //BTDC
label IVC(76.0 * units.deg) //ABDC
label EVO(135.0 * units.deg) //BBDC
label EVC(79.0 * units.deg) //ATDC

label intake_duration(IVO + IVC + rot180)
label exhaust_duration(EVO + EVC + rot180)

label ILC((rot180 - IVO + IVC) / 2.0 + rot360)
label ELC((rot180 - EVO + EVC) / 2.0 + rot180)

label con_rod_mass(7500.0) // ?  g
label slave_rod_mass(700.0) // ?
label crank_mass(150.0) // ? kg
label flywheel_mass(50.0) // kg

label exhaust_delay_coeff(1.5)

public node intake_lobe_profile {
    // lobes.py v1.0 | 320.0 394.0 LSA 107.00 ADV 11.00 OVL 143.0
    alias output __out: _lobe_profile;
    function _lobe_profile(2.581 * units.deg)
        _lobe_profile
        .add_sample(-80.000 * units.deg, 0.000 * units.mm)
        .add_sample(-77.419 * units.deg, 0.014 * units.mm)
        .add_sample(-74.839 * units.deg, 0.044 * units.mm)
        .add_sample(-72.258 * units.deg, 0.089 * units.mm)
        .add_sample(-69.677 * units.deg, 0.152 * units.mm)
        .add_sample(-67.097 * units.deg, 0.246 * units.mm)
        .add_sample(-64.516 * units.deg, 0.380 * units.mm)
        .add_sample(-61.935 * units.deg, 0.546 * units.mm)
        .add_sample(-59.355 * units.deg, 0.749 * units.mm)
        .add_sample(-56.774 * units.deg, 0.995 * units.mm)
        .add_sample(-54.194 * units.deg, 1.323 * units.mm)
        .add_sample(-51.613 * units.deg, 1.729 * units.mm)
        .add_sample(-49.032 * units.deg, 2.204 * units.mm)
        .add_sample(-46.452 * units.deg, 2.781 * units.mm)
        .add_sample(-43.871 * units.deg, 3.465 * units.mm)
        .add_sample(-41.290 * units.deg, 4.224 * units.mm)
        .add_sample(-38.710 * units.deg, 5.054 * units.mm)
        .add_sample(-36.129 * units.deg, 5.948 * units.mm)
        .add_sample(-33.548 * units.deg, 6.892 * units.mm)
        .add_sample(-30.968 * units.deg, 7.869 * units.mm)
        .add_sample(-28.387 * units.deg, 8.857 * units.mm)
        .add_sample(-25.806 * units.deg, 9.833 * units.mm)
        .add_sample(-23.226 * units.deg, 10.767 * units.mm)
        .add_sample(-20.645 * units.deg, 11.639 * units.mm)
        .add_sample(-18.065 * units.deg, 12.540 * units.mm)
        .add_sample(-15.484 * units.deg, 13.341 * units.mm)
        .add_sample(-12.903 * units.deg, 14.018 * units.mm)
        .add_sample(-10.323 * units.deg, 14.582 * units.mm)
        .add_sample(-7.742 * units.deg, 15.122 * units.mm)
        .add_sample(-5.161 * units.deg, 15.493 * units.mm)
        .add_sample(-2.581 * units.deg, 15.685 * units.mm)
        .add_sample(0.000 * units.deg, 15.875 * units.mm)
        .add_sample(2.581 * units.deg, 15.685 * units.mm)
        .add_sample(5.161 * units.deg, 15.493 * units.mm)
        .add_sample(7.742 * units.deg, 15.122 * units.mm)
        .add_sample(10.323 * units.deg, 14.582 * units.mm)
        .add_sample(12.903 * units.deg, 14.018 * units.mm)
        .add_sample(15.484 * units.deg, 13.341 * units.mm)
        .add_sample(18.065 * units.deg, 12.540 * units.mm)
        .add_sample(20.645 * units.deg, 11.639 * units.mm)
        .add_sample(23.226 * units.deg, 10.767 * units.mm)
        .add_sample(25.806 * units.deg, 9.833 * units.mm)
        .add_sample(28.387 * units.deg, 8.857 * units.mm)
        .add_sample(30.968 * units.deg, 7.869 * units.mm)
        .add_sample(33.548 * units.deg, 6.892 * units.mm)
        .add_sample(36.129 * units.deg, 5.948 * units.mm)
        .add_sample(38.710 * units.deg, 5.054 * units.mm)
        .add_sample(41.290 * units.deg, 4.224 * units.mm)
        .add_sample(43.871 * units.deg, 3.465 * units.mm)
        .add_sample(46.452 * units.deg, 2.781 * units.mm)
        .add_sample(49.032 * units.deg, 2.204 * units.mm)
        .add_sample(51.613 * units.deg, 1.729 * units.mm)
        .add_sample(54.194 * units.deg, 1.323 * units.mm)
        .add_sample(56.774 * units.deg, 0.995 * units.mm)
        .add_sample(59.355 * units.deg, 0.749 * units.mm)
        .add_sample(61.935 * units.deg, 0.546 * units.mm)
        .add_sample(64.516 * units.deg, 0.380 * units.mm)
        .add_sample(67.097 * units.deg, 0.246 * units.mm)
        .add_sample(69.677 * units.deg, 0.152 * units.mm)
        .add_sample(72.258 * units.deg, 0.089 * units.mm)
        .add_sample(74.839 * units.deg, 0.044 * units.mm)
        .add_sample(77.419 * units.deg, 0.014 * units.mm)
        .add_sample(80.000 * units.deg, 0.000 * units.mm)
}

public node exhaust_lobe_profile {
    // lobes.py v1.0 | 320.0 394.0 LSA 107.00 ADV 11.00 OVL 143.0
    alias output __out: _lobe_profile;
    function _lobe_profile(3.177 * units.deg)
        _lobe_profile
        .add_sample(-98.500 * units.deg, 0.000 * units.mm)
        .add_sample(-95.323 * units.deg, 0.008 * units.mm)
        .add_sample(-92.145 * units.deg, 0.031 * units.mm)
        .add_sample(-88.968 * units.deg, 0.071 * units.mm)
        .add_sample(-85.790 * units.deg, 0.127 * units.mm)
        .add_sample(-82.613 * units.deg, 0.203 * units.mm)
        .add_sample(-79.435 * units.deg, 0.301 * units.mm)
        .add_sample(-76.258 * units.deg, 0.423 * units.mm)
        .add_sample(-73.081 * units.deg, 0.605 * units.mm)
        .add_sample(-69.903 * units.deg, 0.826 * units.mm)
        .add_sample(-66.726 * units.deg, 1.090 * units.mm)
        .add_sample(-63.548 * units.deg, 1.405 * units.mm)
        .add_sample(-60.371 * units.deg, 1.778 * units.mm)
        .add_sample(-57.194 * units.deg, 2.217 * units.mm)
        .add_sample(-54.016 * units.deg, 2.791 * units.mm)
        .add_sample(-50.839 * units.deg, 3.449 * units.mm)
        .add_sample(-47.661 * units.deg, 4.193 * units.mm)
        .add_sample(-44.484 * units.deg, 5.022 * units.mm)
        .add_sample(-41.306 * units.deg, 5.931 * units.mm)
        .add_sample(-38.129 * units.deg, 6.910 * units.mm)
        .add_sample(-34.952 * units.deg, 7.944 * units.mm)
        .add_sample(-31.774 * units.deg, 9.010 * units.mm)
        .add_sample(-28.597 * units.deg, 10.080 * units.mm)
        .add_sample(-25.419 * units.deg, 11.120 * units.mm)
        .add_sample(-22.242 * units.deg, 12.092 * units.mm)
        .add_sample(-19.065 * units.deg, 12.957 * units.mm)
        .add_sample(-15.887 * units.deg, 13.796 * units.mm)
        .add_sample(-12.710 * units.deg, 14.541 * units.mm)
        .add_sample(-9.532 * units.deg, 15.102 * units.mm)
        .add_sample(-6.355 * units.deg, 15.450 * units.mm)
        .add_sample(-3.177 * units.deg, 15.743 * units.mm)
        .add_sample(0.000 * units.deg, 15.875 * units.mm)
        .add_sample(3.177 * units.deg, 15.743 * units.mm)
        .add_sample(6.355 * units.deg, 15.450 * units.mm)
        .add_sample(9.532 * units.deg, 15.102 * units.mm)
        .add_sample(12.710 * units.deg, 14.541 * units.mm)
        .add_sample(15.887 * units.deg, 13.796 * units.mm)
        .add_sample(19.065 * units.deg, 12.957 * units.mm)
        .add_sample(22.242 * units.deg, 12.092 * units.mm)
        .add_sample(25.419 * units.deg, 11.120 * units.mm)
        .add_sample(28.597 * units.deg, 10.080 * units.mm)
        .add_sample(31.774 * units.deg, 9.010 * units.mm)
        .add_sample(34.952 * units.deg, 7.944 * units.mm)
        .add_sample(38.129 * units.deg, 6.910 * units.mm)
        .add_sample(41.306 * units.deg, 5.931 * units.mm)
        .add_sample(44.484 * units.deg, 5.022 * units.mm)
        .add_sample(47.661 * units.deg, 4.193 * units.mm)
        .add_sample(50.839 * units.deg, 3.449 * units.mm)
        .add_sample(54.016 * units.deg, 2.791 * units.mm)
        .add_sample(57.194 * units.deg, 2.217 * units.mm)
        .add_sample(60.371 * units.deg, 1.778 * units.mm)
        .add_sample(63.548 * units.deg, 1.405 * units.mm)
        .add_sample(66.726 * units.deg, 1.090 * units.mm)
        .add_sample(69.903 * units.deg, 0.826 * units.mm)
        .add_sample(73.081 * units.deg, 0.605 * units.mm)
        .add_sample(76.258 * units.deg, 0.423 * units.mm)
        .add_sample(79.435 * units.deg, 0.301 * units.mm)
        .add_sample(82.613 * units.deg, 0.203 * units.mm)
        .add_sample(85.790 * units.deg, 0.127 * units.mm)
        .add_sample(88.968 * units.deg, 0.071 * units.mm)
        .add_sample(92.145 * units.deg, 0.031 * units.mm)
        .add_sample(95.323 * units.deg, 0.008 * units.mm)
        .add_sample(98.500 * units.deg, 0.000 * units.mm)
}

public node intake_flow {
    alias output __out: _intake_flow;
    function _intake_flow(0.393 * units.mm)
    _intake_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.393, 24.0)
        .add_flow_sample(0.787, 47.1)
        .add_flow_sample(1.180, 68.6)
        .add_flow_sample(1.573, 88.7)
        .add_flow_sample(1.966, 107.3)
        .add_flow_sample(2.360, 124.9)
        .add_flow_sample(2.753, 141.7)
        .add_flow_sample(3.146, 157.7)
        .add_flow_sample(3.540, 173.2)
        .add_flow_sample(3.933, 188.2)
        .add_flow_sample(4.326, 202.8)
        .add_flow_sample(4.719, 217.0)
        .add_flow_sample(5.113, 230.8)
        .add_flow_sample(5.506, 244.2)
        .add_flow_sample(5.899, 257.4)
        .add_flow_sample(6.293, 270.2)
        .add_flow_sample(6.686, 282.8)
        .add_flow_sample(7.079, 295.2)
        .add_flow_sample(7.473, 307.3)
        .add_flow_sample(7.866, 319.1)
        .add_flow_sample(8.259, 330.8)
        .add_flow_sample(8.652, 342.3)
        .add_flow_sample(9.046, 353.5)
        .add_flow_sample(9.439, 364.6)
        .add_flow_sample(9.832, 375.5)
        .add_flow_sample(10.226, 386.2)
        .add_flow_sample(10.619, 396.8)
        .add_flow_sample(11.012, 407.2)
        .add_flow_sample(11.405, 417.6)
        .add_flow_sample(11.799, 427.8)
        .add_flow_sample(12.192, 438.0)
}

public node exhaust_flow {
    alias output __out: _exhaust_flow;
    function _exhaust_flow(0.344 * units.mm)
    _exhaust_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.344, 25.1)
        .add_flow_sample(0.688, 49.2)
        .add_flow_sample(1.032, 71.8)
        .add_flow_sample(1.377, 92.8)
        .add_flow_sample(1.721, 112.4)
        .add_flow_sample(2.065, 131.0)
        .add_flow_sample(2.409, 148.7)
        .add_flow_sample(2.753, 165.6)
        .add_flow_sample(3.097, 182.0)
        .add_flow_sample(3.441, 197.9)
        .add_flow_sample(3.785, 213.4)
        .add_flow_sample(4.130, 228.4)
        .add_flow_sample(4.474, 243.1)
        .add_flow_sample(4.818, 257.4)
        .add_flow_sample(5.162, 271.4)
        .add_flow_sample(5.506, 285.1)
        .add_flow_sample(5.850, 298.5)
        .add_flow_sample(6.194, 311.7)
        .add_flow_sample(6.538, 324.6)
        .add_flow_sample(6.883, 337.3)
        .add_flow_sample(7.227, 349.8)
        .add_flow_sample(7.571, 362.1)
        .add_flow_sample(7.915, 374.2)
        .add_flow_sample(8.259, 386.0)
        .add_flow_sample(8.603, 397.8)
        .add_flow_sample(8.947, 409.3)
        .add_flow_sample(9.291, 420.7)
        .add_flow_sample(9.636, 431.9)
        .add_flow_sample(9.980, 443.0)
        .add_flow_sample(10.324, 454.0)
        .add_flow_sample(10.668, 465.0)
}

intake_lobe_profile intake_lobe_profile()
exhaust_lobe_profile exhaust_lobe_profile()

intake_flow intake_flow()
exhaust_flow exhaust_flow()

public node bank_builder {
    input phasing;
    input ignition;
    input intake;
    input exhaust;

    input pl0;
    input pl1;
    input pl2;
    input pl3;
    input pl4;
    input pl5;
    input pl6;

    output rj0: _rj0;

    output b0: _b0;
    output b1: _b1;
    output b2: _b2;
    output b3: _b3;
    output b4: _b4;
    output b5: _b5;
    output b6: _b6;

    ignition_wire _wire1()
    ignition_wire _wire2()
    ignition_wire _wire3()
    ignition_wire _wire4()
    ignition_wire _wire5()
    ignition_wire _wire6()
    ignition_wire _wire7()

    piston_parameters piston_params(
        mass: 1500 * units.g,
        blowby: k_28inH2O(0.046),
        compression_height: compression_height,
        wrist_pin_position: 0.0,
        displacement: 0.0
    )

    cylinder_bank_parameters bank_params(
        bore: bore * units.mm,
        deck_height: (con_rod + stroke / 2.0) * units.mm + compression_height
    )
    
    connecting_rod_parameters cr_params(
        mass: con_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: con_rod_mass * units.g,
            length: con_rod * units.mm
        ),
        slave_throw: R1 * units.mm,
        center_of_mass: 0.0,
        length: con_rod * units.mm
    )

    connecting_rod_parameters slave_rod_params(
        mass: slave_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: slave_rod_mass * units.g,
            length: L1 * units.mm
        ),
        center_of_mass: 0.0,
        length: L1 * units.mm
    )

    rod_journal _rj0(angle: phasing / 2.0 + rot90)
    rod_journal sj0(angle: -rot * 2.0)
    rod_journal sj1(angle: -rot * 4.0)
    rod_journal sj2(angle: -rot * 6.0)
    rod_journal sj3(angle: -rot * 8.0)
    rod_journal sj4(angle: -rot * 10.0)
    rod_journal sj5(angle: -rot * 12.0)

    connecting_rod mcr0(cr_params)

    mcr0.add_slave_journal(sj0)
    mcr0.add_slave_journal(sj1)
    mcr0.add_slave_journal(sj2)
    mcr0.add_slave_journal(sj3)
    mcr0.add_slave_journal(sj4)
    mcr0.add_slave_journal(sj5)

    camshaft _intake_cam_0(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_0(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)

    camshaft _intake_cam_1(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_1(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_2(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_2(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_3(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_3(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_4(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_4(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_5(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_5(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_6(base_radius: 31.8 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_6(base_radius: 31.8 * units.mm, lobe_profile: exhaust_lobe_profile)

    _intake_cam_0
        .add_lobe(ILC + 0 * rot + phasing)
    _exhaust_cam_0
        .add_lobe(ELC + 0 * rot + phasing)

    _intake_cam_1
        .add_lobe(ILC + 16 * rot + phasing)
    _exhaust_cam_1
        .add_lobe(ELC + 16 * rot + phasing)
    
    _intake_cam_2
        .add_lobe(ILC + 4 * rot + phasing)
    _exhaust_cam_2
        .add_lobe(ELC + 4 * rot + phasing)
    
    _intake_cam_3
        .add_lobe(ILC + 20 * rot + phasing)
    _exhaust_cam_3
        .add_lobe(ELC + 20 * rot + phasing)
    
    _intake_cam_4
        .add_lobe(ILC + 8 * rot + phasing)
    _exhaust_cam_4
        .add_lobe(ELC + 8 * rot + phasing)
        
    _intake_cam_5
        .add_lobe(ILC + 24 * rot + phasing)
    _exhaust_cam_5
        .add_lobe(ELC + 24 * rot + phasing)
        
    _intake_cam_6
        .add_lobe(ILC + 12 * rot + phasing)
    _exhaust_cam_6
        .add_lobe(ELC + 12 * rot + phasing)

    cylinder_bank _b0(bank_params, angle: -(0.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b1(bank_params, angle: -(4.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b2(bank_params, angle: -(8.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b3(bank_params, angle: -(12.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b4(bank_params, angle: -(16.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b5(bank_params, angle: -(20.0 / cyl) * rot360 - phasing / 2.0)
    cylinder_bank _b6(bank_params, angle: -(24.0 / cyl) * rot360 - phasing / 2.0)

    _b0.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: mcr0,
            rod_journal: _rj0,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl0,
            ignition_wire: _wire1
        )
    _b1.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj0,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl1,
            ignition_wire: _wire2
        )
    _b2.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj1,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl2,
            ignition_wire: _wire3
        )
    _b3.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj2,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl3,
            ignition_wire: _wire4
        )
    _b4.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj3,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl4,
            ignition_wire: _wire5
        )
    _b5.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj4,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl5,
            ignition_wire: _wire6
        )
    _b6.add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(slave_rod_params),
            rod_journal: sj5,
            intake: intake,
            exhaust_system: exhaust,
            primary_length: pl6,
            ignition_wire: _wire7
        )

    _b0.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_0,
            exhaust_camshaft: _exhaust_cam_0
        )
    )
    _b1.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_1,
            exhaust_camshaft: _exhaust_cam_1
        )
    )
    _b2.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_2,
            exhaust_camshaft: _exhaust_cam_2
        )
    )
    _b3.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_3,
            exhaust_camshaft: _exhaust_cam_3
        )
    )
    _b4.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_4,
            exhaust_camshaft: _exhaust_cam_4
        )
    )
    _b5.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_5,
            exhaust_camshaft: _exhaust_cam_5
        )
    )
    _b6.set_cylinder_head(
        head(
            intake_camshaft: _intake_cam_6,
            exhaust_camshaft: _exhaust_cam_6
        )
    )

    ignition
        .connect_wire(_wire1, rot * 0 + phasing)
        .connect_wire(_wire3, rot * 4 + phasing + 4.2 * units.deg)
        .connect_wire(_wire5, rot * 8 + phasing - 2.5 * units.deg)
        .connect_wire(_wire7, rot * 12 + phasing - 1.1 * units.deg)
        .connect_wire(_wire2, rot * 16 + phasing + 1.1 * units.deg)
        .connect_wire(_wire4, rot * 20 + phasing + 2.5 * units.deg)
        .connect_wire(_wire6, rot * 24 + phasing - 4.2 * units.deg)
}

private node add_flow_sample {
    input lift;
    input flow;
    input this;
    alias output __out: this;

    this.add_sample(lift * units.mm, k_28inH2O(flow))
}

public node head {
    // port_flow.py v1.5
    // intake port area: 38.6 cm²; saturated lift: 17.10 mm
    // exhaust port area: 38.6 cm²; saturated lift: 17.10 mm
    // cylinder volume: 2553.2 cm³ (155.8 CI); engine volume: 71.488 L (4362.5 CI)
    // chamber volume: 425.5 cm³ (26.0 CI)
    // 16 harmonic intake runner length: 26.9 cm; diameter: 6.4 cm
    // primary length: 41.5 cm, area: 42.5 cm², diameter: 7.4 cm
    // collector diameter: 33.7 cm, area: 892.3 cm²

    input intake_camshaft;
    input exhaust_camshaft;
    input flip_display: false;
    
    alias output __out: head;
    generic_cylinder_head head(
        chamber_volume: 425.527 * units.cc,
        intake_runner_volume: 858.6 * units.cc,
        intake_runner_cross_section_area: 31.9 * units.cm2,
        exhaust_runner_volume: 343.4 * units.cc,
        exhaust_runner_cross_section_area: 42.5 * units.cm2,

        intake_port_flow: intake_flow,
        exhaust_port_flow: exhaust_flow,
        valvetrain: standard_valvetrain(
            intake_camshaft: intake_camshaft,
            exhaust_camshaft: exhaust_camshaft
        ),
        flip_display: flip_display
    )
}

public node eng {
    alias output __out: engine;

    engine engine(
        name: "P&W R-4360",
        starter_torque: 700 * units.Nm,
        starter_speed: 200 * units.rpm,
        redline: redline * units.rpm,
        fuel: a30(),
        throttle_gamma: 2.0,
        jitter: 0.7,
        noise: 0.2,
        hf_gain: 0.002,
        fluid_simulation_steps: 6,
        max_sle_solver_steps: 32,
        simulation_frequency: 3500,
        dyno_min_speed: 500 * units.rpm
    )

    label crank_moment(disk_moment_of_inertia(mass: crank_mass * units.kg, radius: (stroke / 2.0) * units.mm))
    label flywheel_moment(disk_moment_of_inertia(mass: flywheel_mass * units.kg, radius: (stroke * 3.5) * units.mm))
    label other_moment(disk_moment_of_inertia(mass: 1 * units.kg, radius: 1.0 * units.cm))

    crankshaft c0(
        throw: (stroke / 2.0) * units.mm,
        flywheel_mass: flywheel_mass * units.kg,
        mass: crank_mass * units.kg,
        friction_torque: 107.2 * units.Nm,
        moment_of_inertia: crank_moment + flywheel_moment + other_moment,
        position_x: 0.0,
        position_y: 0.0,
        tdc: 0.0
    )

    ignition_module ignition(timing_curve: timing_curve, rev_limit: redline * 1.1 * units.rpm, limiter_duration: 0.001)

    bank_builder bank0(
        phasing: 0.0 * units.deg,
        ignition: ignition,
        intake: intake,
        exhaust: exhaust0,
        pl0 + sh0, pl0 + sh1, pl0 + sh2, pl0 + sh3, pl0 + sh4, pl0 + sh5, pl0 + sh6
    )

    bank_builder bank1(
        phasing: -rot + rot360,
        ignition: ignition,
        intake: intake,
        exhaust: exhaust0,
        pl1 + sh4, pl1 + sh5, pl1 + sh6, pl1 + sh0, pl1 + sh1, pl1 + sh2, pl1 + sh3
    )

    bank_builder bank2(
        phasing: -rot * 2,
        ignition: ignition,
        intake: intake,
        exhaust: exhaust0,
        pl2 + sh0, pl2 + sh1, pl2 + sh2, pl2 + sh3, pl2 + sh4, pl2 + sh5, pl2 + sh6
    )

    bank_builder bank3(
        phasing: -rot * 3 + rot360,
        ignition: ignition,
        intake: intake,
        exhaust: exhaust0,
        pl3 + sh4, pl3 + sh5, pl3 + sh6, pl3 + sh0, pl3 + sh1, pl3 + sh2, pl3 + sh3
    )
    
    c0
        .add_rod_journal(bank0.rj0)
        .add_rod_journal(bank1.rj0)
        .add_rod_journal(bank2.rj0)
        .add_rod_journal(bank3.rj0)

    label collector_cross_section_area(892.3)

    label exhaust_pipe_length_0(200.0) // cm
    label exhaust_volume_0(collector_cross_section_area * exhaust_pipe_length_0 / 100.0) // Litres
    
    label spacing_factor(1.5)
    label flange_density(1.0 * exhaust_delay_coeff)

    intake intake(
        plenum_volume: 33.8 * units.L,
        plenum_cross_section_area: 446.7 * units.cm2,
        runner_length: 26.9 * units.cm,
        intake_flow_rate: k_carb(3887.2),
        idle_flow_rate: k_carb(0.05),
        idle_throttle_plate_position: 0.995,
        runner_flow_rate: k_carb(312.4),
        velocity_decay: 0.05
    )
    
    exhaust_system_parameters es_params0(
        outlet_flow_rate: k_carb(6883.6),
        collector_cross_section_area: 892.3 * units.cm2,
        length: exhaust_pipe_length_0 * units.cm,
        primary_tube_length: 41.5 * units.cm,
        primary_flow_rate: k_carb(522.4),
        velocity_decay: 0.5,
        volume: exhaust_volume_0 * units.L
    )

    exhaust_system exhaust0(es_params0, impulse_response: impulse_response(filename: "../../impulse_responses/smooth_52.wav", volume: 0.001))
    
    label pl0((1.0 * bore * spacing_factor / flange_density) * units.mm)
    label pl1((2.5 * bore * spacing_factor / flange_density) * units.mm)
    label pl2((4.0 * bore * spacing_factor / flange_density) * units.mm)
    label pl3((5.5 * bore * spacing_factor / flange_density) * units.mm)

    label sh0((1.0 * bore * spacing_factor / flange_density) * units.mm)
    label sh1((4.0 * bore * spacing_factor / flange_density) * units.mm)
    label sh2((8.0 * bore * spacing_factor / flange_density) * units.mm)
    label sh3((12.0 * bore * spacing_factor / flange_density) * units.mm) // outmost mid point
    label sh4((9.0 * bore * spacing_factor / flange_density) * units.mm)
    label sh5((5.0 * bore * spacing_factor / flange_density) * units.mm)
    label sh6((3.0 * bore * spacing_factor / flange_density) * units.mm)

    engine
        .add_cylinder_bank(bank0.b0)
        .add_cylinder_bank(bank0.b1)
        .add_cylinder_bank(bank0.b2)
        .add_cylinder_bank(bank0.b3)
        .add_cylinder_bank(bank0.b4)
        .add_cylinder_bank(bank0.b5)
        .add_cylinder_bank(bank0.b6)
        
        .add_cylinder_bank(bank1.b0)
        .add_cylinder_bank(bank1.b1)
        .add_cylinder_bank(bank1.b2)
        .add_cylinder_bank(bank1.b3)
        .add_cylinder_bank(bank1.b4)
        .add_cylinder_bank(bank1.b5)
        .add_cylinder_bank(bank1.b6)

        .add_cylinder_bank(bank2.b0)
        .add_cylinder_bank(bank2.b1)
        .add_cylinder_bank(bank2.b2)
        .add_cylinder_bank(bank2.b3)
        .add_cylinder_bank(bank2.b4)
        .add_cylinder_bank(bank2.b5)
        .add_cylinder_bank(bank2.b6)

        .add_cylinder_bank(bank3.b0)
        .add_cylinder_bank(bank3.b1)
        .add_cylinder_bank(bank3.b2)
        .add_cylinder_bank(bank3.b3)
        .add_cylinder_bank(bank3.b4)
        .add_cylinder_bank(bank3.b5)
        .add_cylinder_bank(bank3.b6)

        .add_crankshaft(c0)
        .add_ignition_module(ignition)

    // ignition_timing.py v0.1 r = 1.24
    function timing_curve(1000 * units.rpm)
    timing_curve
        .add_sample(0000 * units.rpm, 8.0 * units.deg)
        .add_sample(0500 * units.rpm, 9.9 * units.deg)
        .add_sample(1000 * units.rpm, 12.3 * units.deg)
        .add_sample(1500 * units.rpm, 15.3 * units.deg)
        .add_sample(2000 * units.rpm, 18.9 * units.deg)
        .add_sample(2500 * units.rpm, 23.5 * units.deg)
        .add_sample(3000 * units.rpm, 29.1 * units.deg)
}

// Bugatti Type 41
public node veh {
    alias output __out: vehicle;
    vehicle vehicle(
        mass: 3250  * units.kg,
        drag_coefficient: 0.5,
        cross_sectional_area: (1320 * units.mm) * (1050 * units.mm),
        diff_ratio: 3.6,
        tire_radius: (914.4 / 2) * units.mm, // 36 x 6.75
        rolling_resistance: 20
        )
}

// Bugatti Type 41
private node trn {
    alias output __out:
        transmission(
            max_clutch_torque: 6000 * units.Nm,
            max_clutch_flex: 15 * units.deg,
            limit_clutch_flex: true,
            clutch_stiffness: 100 * units.Nm / units.deg,
            clutch_damping: 1.0,
            simulate_flex: true
        )
        .add_gear(7.50)
        .add_gear(1.0)
        .add_gear(0.37);
}

run(
    engine: eng(),
    transmission: trn(),
    vehicle: veh()
)