
// Engine Sim V0.1.14A
// 1936 Cord 810 (Lycoming FB) 1936 125 @ 3500
// Created by oror 2023
// Native order 1L-3L-4L-2L-2R-1R-3R-4R
// 1-3-4-2-6-5-7-8 :: 1-8-6-5-7-3-4-2

// Cord 812
// Native order 1L-3L-3R-2L-2R-1R-4L-4R
// 1-3-7-2-6-5-4-8 :: 1-8-6-2-7-3-4-5

/*
{
  "cam_cfg": {
    "equal_base_radius": true,
    "es_version": "0.1.14a",
    "exhaust_at_lift": 0.889,
    "exhaust_base_mult": 2.0,
    "exhaust_cos": false,
    "exhaust_sigma": 2.0,
    "exhaust_trim": 0.7,
    "exhaust_volume": 0.35,
    "intake_at_lift": 0.889,
    "intake_base_mult": 2.0,
    "intake_cos": false,
    "intake_sigma": 2.0,
    "intake_trim": 0.7,
    "intake_volume": 0.35,
    "lift_significant_fraction": 250.0,
    "ramp_position": 0.0,
    "ramp_steepness": 1.0,
    "resolution": 64,
    "roller_tappet_radius": 0.6
  },
  "engine": {
    "catalog_id": 294,
    "description": [
      "This engine is interesting because of its LLLLRRRR firing order 1-3-4-2-6-5-7-8.",
      "It has a cross-plane crank like a regular american V8 but ignition wise it is exactly like two inline fours firing one after another.",
      "So one full bank fires first and then goes the other one, resulting in very uneven exhaust pulse situation.",
      "Eventually it all goes into just one exhaust pipe (I checked the real photos).",
      "The firing order is realistic, I took it from the Cord document.",
      "Later in 1938 Cord put a supercharger and changed firing order to a more conventional 1-3-7-2-6-5-4-8 and that became Cord 812."
    ],
    "enable_update": true,
    "es_version": "V0.1.14A",
    "name": "Cord 810 V8 1936",
    "yt_handle": "Ca2PJ_pTqHQ"
  },
  "flow_cfg": {
    "collector_area_coeff": 0.3,
    "exhaust_flange_dia": null,
    "exhaust_port_dia": null,
    "exhaust_stem_dia": null,
    "intake_port_dia": null,
    "intake_runner_dia_mult": 1.0,
    "intake_stem_dia": null,
    "ir_to_er_ratio": 3.0,
    "max_power_rpm": 3500.0,
    "max_torque_rpm": 1600.0,
    "port_to_valve_area": 0.82,
    "power_factor": 1.0,
    "primary_area_coeff": 1.1,
    "resolution": 32,
    "smoothness": 2.0,
    "valve_to_stem_dia": 4.9
  },
  "ign_cfg": {
    "end_deg": 30,
    "end_rpm": 3000,
    "exp_mode": 2,
    "flywheel": 0,
    "resolution": 16,
    "start_rpm": 600
  }
}
*/

import "engine_sim.mr"
import "_fuel_30.mr"

units units()
constants constants()

label bore(88.9)
label stroke(95.25)
label compression_ratio(6.5)
label con_rod(193.675) // 7 5/8
label compression_height(56.6928 * units.mm) // 2.23200
label intake_valve_diameter(43.6563) // 1 23/32
label exhaust_valve_diameter(38.4969) // 1 33/64
label intake_valves(1.0)
label exhaust_valves(1.0)

label redline(4000.0) // RPM

label cyl(8.0)
label row(2.0)
label cycle(720.0 * units.deg)
label vee(90.0 * units.deg)
label rot(cycle / cyl)
label rot90(90.0 * units.deg)
label rot180(180.0 * units.deg)
label rot360(360.0 * units.deg)

// Cord 810 valve timings
label IVL(8.73125) // 11/32
label EVL(8.73125) // 11/32
label IVO(7.5 * units.deg) //BTDC
label IVC(37.5 * units.deg) //ABDC
label EVO(50.0 * units.deg) //BBDC
label EVC(5.0 * units.deg) //ATDC

label intake_duration(IVO + IVC + rot180)
label exhaust_duration(EVO + EVC + rot180)

label ILC((rot180 - IVO + IVC) / 2.0 + rot360)
label ELC((rot180 - EVO + EVC) / 2.0 + rot180)

label con_rod_mass(700.0) // ? chatgpt g
label crank_mass(25.0) // ? chatgpt kg
label flywheel_mass(16.0) // chatgpt kg

label exhaust_delay_coeff(1.5)

label spacing_factor(1.1)
label flange_density(1.0 * exhaust_delay_coeff)

private node wires {
    output wire1: ignition_wire();
    output wire2: ignition_wire();
    output wire3: ignition_wire();
    output wire4: ignition_wire();
    output wire5: ignition_wire();
    output wire6: ignition_wire();
    output wire7: ignition_wire();
    output wire8: ignition_wire();
}

public node intake_lobe_profile {
    // lobes.py v1.0 | 225.0 235.0 LSA 108.75 ADV 3.75 OVL 12.5
    alias output __out: _lobe_profile;
    function _lobe_profile(2.442 * units.deg)
        _lobe_profile
        .add_sample(-78.137 * units.deg, 0.000 * units.mm)
        .add_sample(-75.696 * units.deg, 0.022 * units.mm)
        .add_sample(-73.254 * units.deg, 0.072 * units.mm)
        .add_sample(-70.812 * units.deg, 0.137 * units.mm)
        .add_sample(-68.370 * units.deg, 0.222 * units.mm)
        .add_sample(-65.928 * units.deg, 0.328 * units.mm)
        .add_sample(-63.487 * units.deg, 0.475 * units.mm)
        .add_sample(-61.045 * units.deg, 0.659 * units.mm)
        .add_sample(-58.603 * units.deg, 0.857 * units.mm)
        .add_sample(-56.161 * units.deg, 1.011 * units.mm)
        .add_sample(-53.719 * units.deg, 1.185 * units.mm)
        .add_sample(-51.278 * units.deg, 1.377 * units.mm)
        .add_sample(-48.836 * units.deg, 1.589 * units.mm)
        .add_sample(-46.394 * units.deg, 1.822 * units.mm)
        .add_sample(-43.952 * units.deg, 2.095 * units.mm)
        .add_sample(-41.510 * units.deg, 2.400 * units.mm)
        .add_sample(-39.069 * units.deg, 2.736 * units.mm)
        .add_sample(-36.627 * units.deg, 3.107 * units.mm)
        .add_sample(-34.185 * units.deg, 3.520 * units.mm)
        .add_sample(-31.743 * units.deg, 3.994 * units.mm)
        .add_sample(-29.302 * units.deg, 4.507 * units.mm)
        .add_sample(-26.860 * units.deg, 5.052 * units.mm)
        .add_sample(-24.418 * units.deg, 5.605 * units.mm)
        .add_sample(-21.976 * units.deg, 6.134 * units.mm)
        .add_sample(-19.534 * units.deg, 6.682 * units.mm)
        .add_sample(-17.093 * units.deg, 7.158 * units.mm)
        .add_sample(-14.651 * units.deg, 7.559 * units.mm)
        .add_sample(-12.209 * units.deg, 7.936 * units.mm)
        .add_sample(-9.767 * units.deg, 8.190 * units.mm)
        .add_sample(-7.325 * units.deg, 8.438 * units.mm)
        .add_sample(-4.884 * units.deg, 8.584 * units.mm)
        .add_sample(-2.442 * units.deg, 8.667 * units.mm)
        .add_sample(0.000 * units.deg, 8.731 * units.mm)
        .add_sample(2.442 * units.deg, 8.667 * units.mm)
        .add_sample(4.884 * units.deg, 8.584 * units.mm)
        .add_sample(7.325 * units.deg, 8.438 * units.mm)
        .add_sample(9.767 * units.deg, 8.190 * units.mm)
        .add_sample(12.209 * units.deg, 7.936 * units.mm)
        .add_sample(14.651 * units.deg, 7.559 * units.mm)
        .add_sample(17.093 * units.deg, 7.158 * units.mm)
        .add_sample(19.534 * units.deg, 6.682 * units.mm)
        .add_sample(21.976 * units.deg, 6.134 * units.mm)
        .add_sample(24.418 * units.deg, 5.605 * units.mm)
        .add_sample(26.860 * units.deg, 5.052 * units.mm)
        .add_sample(29.302 * units.deg, 4.507 * units.mm)
        .add_sample(31.743 * units.deg, 3.994 * units.mm)
        .add_sample(34.185 * units.deg, 3.520 * units.mm)
        .add_sample(36.627 * units.deg, 3.107 * units.mm)
        .add_sample(39.069 * units.deg, 2.736 * units.mm)
        .add_sample(41.510 * units.deg, 2.400 * units.mm)
        .add_sample(43.952 * units.deg, 2.095 * units.mm)
        .add_sample(46.394 * units.deg, 1.822 * units.mm)
        .add_sample(48.836 * units.deg, 1.589 * units.mm)
        .add_sample(51.278 * units.deg, 1.377 * units.mm)
        .add_sample(53.719 * units.deg, 1.185 * units.mm)
        .add_sample(56.161 * units.deg, 1.011 * units.mm)
        .add_sample(58.603 * units.deg, 0.857 * units.mm)
        .add_sample(61.045 * units.deg, 0.659 * units.mm)
        .add_sample(63.487 * units.deg, 0.475 * units.mm)
        .add_sample(65.928 * units.deg, 0.328 * units.mm)
        .add_sample(68.370 * units.deg, 0.222 * units.mm)
        .add_sample(70.812 * units.deg, 0.137 * units.mm)
        .add_sample(73.254 * units.deg, 0.072 * units.mm)
        .add_sample(75.696 * units.deg, 0.022 * units.mm)
        .add_sample(78.137 * units.deg, 0.000 * units.mm)
}

public node exhaust_lobe_profile {
    // lobes.py v1.0 | 225.0 235.0 LSA 108.75 ADV 3.75 OVL 12.5
    alias output __out: _lobe_profile;
    function _lobe_profile(2.550 * units.deg)
        _lobe_profile
        .add_sample(-81.610 * units.deg, 0.000 * units.mm)
        .add_sample(-79.060 * units.deg, 0.019 * units.mm)
        .add_sample(-76.510 * units.deg, 0.068 * units.mm)
        .add_sample(-73.959 * units.deg, 0.133 * units.mm)
        .add_sample(-71.409 * units.deg, 0.218 * units.mm)
        .add_sample(-68.859 * units.deg, 0.324 * units.mm)
        .add_sample(-66.308 * units.deg, 0.459 * units.mm)
        .add_sample(-63.758 * units.deg, 0.642 * units.mm)
        .add_sample(-61.208 * units.deg, 0.840 * units.mm)
        .add_sample(-58.657 * units.deg, 0.994 * units.mm)
        .add_sample(-56.107 * units.deg, 1.168 * units.mm)
        .add_sample(-53.557 * units.deg, 1.359 * units.mm)
        .add_sample(-51.006 * units.deg, 1.570 * units.mm)
        .add_sample(-48.456 * units.deg, 1.803 * units.mm)
        .add_sample(-45.906 * units.deg, 2.060 * units.mm)
        .add_sample(-43.355 * units.deg, 2.355 * units.mm)
        .add_sample(-40.805 * units.deg, 2.690 * units.mm)
        .add_sample(-38.255 * units.deg, 3.059 * units.mm)
        .add_sample(-35.704 * units.deg, 3.465 * units.mm)
        .add_sample(-33.154 * units.deg, 3.913 * units.mm)
        .add_sample(-30.604 * units.deg, 4.406 * units.mm)
        .add_sample(-28.053 * units.deg, 4.946 * units.mm)
        .add_sample(-25.503 * units.deg, 5.498 * units.mm)
        .add_sample(-22.953 * units.deg, 6.072 * units.mm)
        .add_sample(-20.403 * units.deg, 6.618 * units.mm)
        .add_sample(-17.852 * units.deg, 7.092 * units.mm)
        .add_sample(-15.302 * units.deg, 7.530 * units.mm)
        .add_sample(-12.752 * units.deg, 7.907 * units.mm)
        .add_sample(-10.201 * units.deg, 8.173 * units.mm)
        .add_sample(-7.651 * units.deg, 8.431 * units.mm)
        .add_sample(-5.101 * units.deg, 8.577 * units.mm)
        .add_sample(-2.550 * units.deg, 8.667 * units.mm)
        .add_sample(0.000 * units.deg, 8.731 * units.mm)
        .add_sample(2.550 * units.deg, 8.667 * units.mm)
        .add_sample(5.101 * units.deg, 8.577 * units.mm)
        .add_sample(7.651 * units.deg, 8.431 * units.mm)
        .add_sample(10.201 * units.deg, 8.173 * units.mm)
        .add_sample(12.752 * units.deg, 7.907 * units.mm)
        .add_sample(15.302 * units.deg, 7.530 * units.mm)
        .add_sample(17.852 * units.deg, 7.092 * units.mm)
        .add_sample(20.403 * units.deg, 6.618 * units.mm)
        .add_sample(22.953 * units.deg, 6.072 * units.mm)
        .add_sample(25.503 * units.deg, 5.498 * units.mm)
        .add_sample(28.053 * units.deg, 4.946 * units.mm)
        .add_sample(30.604 * units.deg, 4.406 * units.mm)
        .add_sample(33.154 * units.deg, 3.913 * units.mm)
        .add_sample(35.704 * units.deg, 3.465 * units.mm)
        .add_sample(38.255 * units.deg, 3.059 * units.mm)
        .add_sample(40.805 * units.deg, 2.690 * units.mm)
        .add_sample(43.355 * units.deg, 2.355 * units.mm)
        .add_sample(45.906 * units.deg, 2.060 * units.mm)
        .add_sample(48.456 * units.deg, 1.803 * units.mm)
        .add_sample(51.006 * units.deg, 1.570 * units.mm)
        .add_sample(53.557 * units.deg, 1.359 * units.mm)
        .add_sample(56.107 * units.deg, 1.168 * units.mm)
        .add_sample(58.657 * units.deg, 0.994 * units.mm)
        .add_sample(61.208 * units.deg, 0.840 * units.mm)
        .add_sample(63.758 * units.deg, 0.642 * units.mm)
        .add_sample(66.308 * units.deg, 0.459 * units.mm)
        .add_sample(68.859 * units.deg, 0.324 * units.mm)
        .add_sample(71.409 * units.deg, 0.218 * units.mm)
        .add_sample(73.959 * units.deg, 0.133 * units.mm)
        .add_sample(76.510 * units.deg, 0.068 * units.mm)
        .add_sample(79.060 * units.deg, 0.019 * units.mm)
        .add_sample(81.610 * units.deg, 0.000 * units.mm)
}

public node intake_flow {
    alias output __out: _intake_flow;
    function _intake_flow(0.282 * units.mm)
    _intake_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.282, 9.0)
        .add_flow_sample(0.563, 17.6)
        .add_flow_sample(0.845, 25.7)
        .add_flow_sample(1.127, 33.1)
        .add_flow_sample(1.408, 40.0)
        .add_flow_sample(1.690, 46.5)
        .add_flow_sample(1.972, 52.7)
        .add_flow_sample(2.253, 58.6)
        .add_flow_sample(2.535, 64.2)
        .add_flow_sample(2.817, 69.7)
        .add_flow_sample(3.098, 75.0)
        .add_flow_sample(3.380, 80.1)
        .add_flow_sample(3.661, 85.1)
        .add_flow_sample(3.943, 89.9)
        .add_flow_sample(4.225, 94.7)
        .add_flow_sample(4.506, 99.3)
        .add_flow_sample(4.788, 103.8)
        .add_flow_sample(5.070, 108.2)
        .add_flow_sample(5.351, 112.5)
        .add_flow_sample(5.633, 116.8)
        .add_flow_sample(5.915, 120.9)
        .add_flow_sample(6.196, 125.0)
        .add_flow_sample(6.478, 129.0)
        .add_flow_sample(6.760, 132.9)
        .add_flow_sample(7.041, 136.7)
        .add_flow_sample(7.323, 140.5)
        .add_flow_sample(7.605, 144.2)
        .add_flow_sample(7.886, 147.9)
        .add_flow_sample(8.168, 151.5)
        .add_flow_sample(8.450, 155.1)
        .add_flow_sample(8.731, 158.7)
}

public node exhaust_flow {
    alias output __out: _exhaust_flow;
    function _exhaust_flow(0.282 * units.mm)
    _exhaust_flow
        .add_flow_sample(0.000, 0.0)
        .add_flow_sample(0.282, 9.0)
        .add_flow_sample(0.563, 17.7)
        .add_flow_sample(0.845, 25.8)
        .add_flow_sample(1.127, 33.2)
        .add_flow_sample(1.408, 40.1)
        .add_flow_sample(1.690, 46.6)
        .add_flow_sample(1.972, 52.7)
        .add_flow_sample(2.253, 58.5)
        .add_flow_sample(2.535, 64.1)
        .add_flow_sample(2.817, 69.5)
        .add_flow_sample(3.098, 74.7)
        .add_flow_sample(3.380, 79.8)
        .add_flow_sample(3.661, 84.7)
        .add_flow_sample(3.943, 89.5)
        .add_flow_sample(4.225, 94.2)
        .add_flow_sample(4.506, 98.7)
        .add_flow_sample(4.788, 103.1)
        .add_flow_sample(5.070, 107.4)
        .add_flow_sample(5.351, 111.7)
        .add_flow_sample(5.633, 115.8)
        .add_flow_sample(5.915, 119.9)
        .add_flow_sample(6.196, 123.8)
        .add_flow_sample(6.478, 127.7)
        .add_flow_sample(6.760, 131.5)
        .add_flow_sample(7.041, 135.3)
        .add_flow_sample(7.323, 138.9)
        .add_flow_sample(7.605, 142.4)
        .add_flow_sample(7.886, 145.7)
        .add_flow_sample(8.168, 148.7)
        .add_flow_sample(8.450, 151.4)
        .add_flow_sample(8.731, 154.0)
}

intake_lobe_profile intake_lobe_profile()
exhaust_lobe_profile exhaust_lobe_profile()

intake_flow intake_flow()
exhaust_flow exhaust_flow()

// Cord 810 1-3-4-2-6-5-7-8
public node layout_0 {
    input wires;
    input timing_curve;
    input rev_limit;
    input limiter_duration;

    output intake_cam_0: _intake_cam_0;
    output exhaust_cam_0: _exhaust_cam_0;

    output intake_cam_1: _intake_cam_1;
    output exhaust_cam_1: _exhaust_cam_1;

    output ignition: _ign;

    output pl0: _pl0;
    output pl1: _pl1;
    output pl2: _pl2;
    output pl3: _pl3;

    output name: "Cord 810";

    ignition_module _ign(timing_curve: timing_curve, rev_limit: rev_limit, limiter_duration: limiter_duration)
    _ign
        .connect_wire(wires.wire1, rot * 0)
        .connect_wire(wires.wire3, rot * 1)
        .connect_wire(wires.wire4, rot * 2)
        .connect_wire(wires.wire2, rot * 3)
        .connect_wire(wires.wire6, rot * 4)
        .connect_wire(wires.wire5, rot * 5)
        .connect_wire(wires.wire7, rot * 6)
        .connect_wire(wires.wire8, rot * 7)

    camshaft _intake_cam_0(base_radius: 17.5 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_0(base_radius: 17.5 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_1(base_radius: 17.5 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_1(base_radius: 17.5 * units.mm, lobe_profile: exhaust_lobe_profile)

    _intake_cam_0
        .add_lobe(ILC + 0 * rot)
        .add_lobe(ILC + 3 * rot)
        .add_lobe(ILC + 1 * rot)
        .add_lobe(ILC + 2 * rot)
    _exhaust_cam_0
        .add_lobe(ELC + 0 * rot)
        .add_lobe(ELC + 3 * rot)
        .add_lobe(ELC + 1 * rot)
        .add_lobe(ELC + 2 * rot)
        
    _intake_cam_1
        .add_lobe(ILC + 5 * rot)
        .add_lobe(ILC + 4 * rot)
        .add_lobe(ILC + 6 * rot)
        .add_lobe(ILC + 7 * rot)
    _exhaust_cam_1
        .add_lobe(ELC + 5 * rot)
        .add_lobe(ELC + 4 * rot)
        .add_lobe(ELC + 6 * rot)
        .add_lobe(ELC + 7 * rot)

    float _pl0((1.0 * bore * spacing_factor / flange_density) * units.mm)
    float _pl1((1.7 * bore * spacing_factor / flange_density) * units.mm)
    float _pl2((3.2 * bore * spacing_factor / flange_density) * units.mm)
    float _pl3((3.8 * bore * spacing_factor / flange_density) * units.mm)
}

// Cord 812 1-3-7-2-6-5-4-8
public node layout_1 {
    input wires;
    input timing_curve;
    input rev_limit;
    input limiter_duration;

    output intake_cam_0: _intake_cam_0;
    output exhaust_cam_0: _exhaust_cam_0;

    output intake_cam_1: _intake_cam_1;
    output exhaust_cam_1: _exhaust_cam_1;

    output ignition: _ign;

    output pl0: _pl0;
    output pl1: _pl1;
    output pl2: _pl2;
    output pl3: _pl3;

    output name: "Cord 812";

    ignition_module _ign(timing_curve: timing_curve, rev_limit: rev_limit, limiter_duration: limiter_duration)
    _ign
        .connect_wire(wires.wire1, rot * 0)
        .connect_wire(wires.wire3, rot * 1)
        .connect_wire(wires.wire7, rot * 2)
        .connect_wire(wires.wire2, rot * 3)
        .connect_wire(wires.wire6, rot * 4)
        .connect_wire(wires.wire5, rot * 5)
        .connect_wire(wires.wire4, rot * 6)
        .connect_wire(wires.wire8, rot * 7)

    camshaft _intake_cam_0(base_radius: 17.5 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_0(base_radius: 17.5 * units.mm, lobe_profile: exhaust_lobe_profile)
    
    camshaft _intake_cam_1(base_radius: 17.5 * units.mm, lobe_profile: intake_lobe_profile)
    camshaft _exhaust_cam_1(base_radius: 17.5 * units.mm, lobe_profile: exhaust_lobe_profile)

    _intake_cam_0
        .add_lobe(ILC + 0 * rot)
        .add_lobe(ILC + 3 * rot)
        .add_lobe(ILC + 1 * rot)
        .add_lobe(ILC + 6 * rot)
    _exhaust_cam_0
        .add_lobe(ELC + 0 * rot)
        .add_lobe(ELC + 3 * rot)
        .add_lobe(ELC + 1 * rot)
        .add_lobe(ELC + 6 * rot)
    
    _intake_cam_1
        .add_lobe(ILC + 5 * rot)
        .add_lobe(ILC + 4 * rot)
        .add_lobe(ILC + 2 * rot)
        .add_lobe(ILC + 7 * rot)
    _exhaust_cam_1
        .add_lobe(ELC + 5 * rot)
        .add_lobe(ELC + 4 * rot)
        .add_lobe(ELC + 2 * rot)
        .add_lobe(ELC + 7 * rot)

    float _pl0((3.0 * bore * spacing_factor / flange_density) * units.mm)
    float _pl1((3.0 * bore * spacing_factor / flange_density) * units.mm)
    float _pl2((1.0 * bore * spacing_factor / flange_density) * units.mm)
    float _pl3((1.0 * bore * spacing_factor / flange_density) * units.mm)
}

private node add_flow_sample {
    input lift;
    input flow;
    input this;
    alias output __out: this;

    this.add_sample(lift * units.mm, k_28inH2O(flow))
}

public node head {
    // port_flow.py v1.5
    // intake port area: 11.7 cm²; saturated lift: 9.38 mm
    // exhaust port area: 9.1 cm²; saturated lift: 8.27 mm
    // cylinder volume: 591.2 cm³ (36.1 CI); engine volume: 4.730 L (288.6 CI)
    // chamber volume: 107.5 cm³ (6.6 CI)
    // 16 harmonic intake runner length: 26.6 cm; diameter: 3.4 cm
    // primary length: 45.9 cm, area: 10.0 cm², diameter: 3.6 cm
    // collector diameter: 5.5 cm, area: 23.9 cm²

    input intake_camshaft;
    input exhaust_camshaft;
    input flip_display: false;
    
    alias output __out: head;
    generic_cylinder_head head(
        chamber_volume: 107.497 * units.cc,
        intake_runner_volume: 245.5 * units.cc,
        intake_runner_cross_section_area: 9.2 * units.cm2,
        exhaust_runner_volume: 81.8 * units.cc,
        exhaust_runner_cross_section_area: 10.0 * units.cm2,

        intake_port_flow: intake_flow,
        exhaust_port_flow: exhaust_flow,
        valvetrain: standard_valvetrain(
            intake_camshaft: intake_camshaft,
            exhaust_camshaft: exhaust_camshaft
        ),
        flip_display: flip_display
    )
}

public node eng {
    alias output __out: engine;

    engine engine(
        name: engine_config.name,
        starter_torque: 100 * units.Nm,
        starter_speed: 300 * units.rpm,
        redline: redline * units.rpm,
        fuel: s30(),
        throttle_gamma: 1.5,
        jitter: 0.8,
        noise: 0.1,
        hf_gain: 0.002,
        simulation_frequency: 12000 
    )

    wires wires()

    connecting_rod_parameters cr_params(
        mass: con_rod_mass * units.g,
        moment_of_inertia: rod_moment_of_inertia(
            mass: con_rod_mass * units.g,
            length: con_rod * units.mm
        ),
        center_of_mass: 0.0,
        length: con_rod * units.mm
    )

    label crank_moment(disk_moment_of_inertia(mass: crank_mass * units.kg, radius: (stroke / 2.0) * units.mm))
    label flywheel_moment(disk_moment_of_inertia(mass: flywheel_mass * units.kg, radius: (stroke * 2.7) * units.mm))
    label other_moment(disk_moment_of_inertia(mass: 1 * units.kg, radius: 1.0 * units.cm))

    crankshaft c0(
        throw: (stroke / 2.0) * units.mm,
        flywheel_mass: flywheel_mass * units.kg,
        mass: crank_mass * units.kg,
        friction_torque: 7.1 * units.Nm,
        moment_of_inertia: crank_moment + flywheel_moment + other_moment,
        tdc: 0.0
    )

    layout_0 engine_config(
        wires: wires,
        timing_curve: timing_curve,
        rev_limit: 4500 * units.rpm,
        limiter_duration: 0.0001
    )

    rod_journal rj0(angle: rot * 0 + rot90 + vee / 2)
    rod_journal rj1(angle: rot * 3 + rot90 + vee / 2)
    rod_journal rj2(angle: rot * 1 + rot90 + vee / 2)
    rod_journal rj3(angle: rot * 2 + rot90 + vee / 2)
    
    c0
        .add_rod_journal(rj0)
        .add_rod_journal(rj1)
        .add_rod_journal(rj2)
        .add_rod_journal(rj3)

    piston_parameters piston_params(
        mass: 450.0 * units.g,
        blowby: k_28inH2O(0.028),
        compression_height: compression_height,
        wrist_pin_position: 0.0,
        displacement: 0.0
    )

    cylinder_bank_parameters bank_params(
        bore: bore * units.mm,
        deck_height: (con_rod + stroke / 2.0) * units.mm + compression_height
    )

    label collector_cross_section_area(23.9)

    label exhaust_pipe_length_0(330.0) // cm
    label exhaust_volume_0(collector_cross_section_area * exhaust_pipe_length_0 / 100.0) // Litres

    intake intake(
        plenum_volume: 2.5 * units.L,
        plenum_cross_section_area: 36.9 * units.cm2,
        runner_length: 26.6 * units.cm,
        intake_flow_rate: k_carb(315.3),
        idle_flow_rate: k_carb(0.03),
        idle_throttle_plate_position: 0.996,
        runner_flow_rate: k_carb(78.8),
        velocity_decay: 0.05
    )
    
    exhaust_system_parameters es_params0(
        outlet_flow_rate: k_carb(525.5),
        collector_cross_section_area: 23.9 * units.cm2,
        length: exhaust_pipe_length_0 * units.cm,
        primary_tube_length: 45.9 * units.cm,
        primary_flow_rate: k_carb(131.4),
        velocity_decay: 1.0,
        volume: (exhaust_volume_0 + 7.0) * units.L
    )

    exhaust_system exhaust0(es_params0, impulse_response: impulse_response(filename: "../../impulse_responses/smooth_56.wav", volume: 0.00025))
 
    cylinder_bank b0(bank_params, angle: vee / 2)
    cylinder_bank b1(bank_params, angle: -vee / 2)

    label sh((350.0 / exhaust_delay_coeff) * units.mm)

    b0
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj0,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl0,
            ignition_wire: wires.wire1
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj1,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl1,
            ignition_wire: wires.wire2
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj2,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl2,
            ignition_wire: wires.wire3
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj3,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl3,
            ignition_wire: wires.wire4
        )
        
    b1
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj0,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl0 + sh,
            ignition_wire: wires.wire5
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj1,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl1 + sh,
            ignition_wire: wires.wire6
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj2,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl2 + sh,
            ignition_wire: wires.wire7
        )
        .add_cylinder(
            piston: piston(piston_params),
            connecting_rod: connecting_rod(cr_params),
            rod_journal: rj3,
            intake: intake,
            exhaust_system: exhaust0,
            primary_length: engine_config.pl3 + sh,
            ignition_wire: wires.wire8
        )

    engine
        .add_cylinder_bank(b0)
        .add_cylinder_bank(b1)

    engine.add_crankshaft(c0)

    b0.set_cylinder_head (
        head(
            intake_camshaft: engine_config.intake_cam_0,
            exhaust_camshaft: engine_config.exhaust_cam_0,
            flip_display: true
        )
    )
    b1.set_cylinder_head (
        head(
            intake_camshaft: engine_config.intake_cam_1,
            exhaust_camshaft: engine_config.exhaust_cam_1
        )
    )

    function timing_curve(266.7 * units.rpm)
    timing_curve
        .add_sample(0.0 * units.rpm, 0.0 * units.deg)
        .add_sample(266.7 * units.rpm, 0.0 * units.deg)
        .add_sample(533.3 * units.rpm, 0.0 * units.deg)
        .add_sample(800.0 * units.rpm, 8.4 * units.deg)
        .add_sample(1066.7 * units.rpm, 15.5 * units.deg)
        .add_sample(1333.3 * units.rpm, 20.4 * units.deg)
        .add_sample(1600.0 * units.rpm, 23.7 * units.deg)
        .add_sample(1866.7 * units.rpm, 26.0 * units.deg)
        .add_sample(2133.3 * units.rpm, 27.6 * units.deg)
        .add_sample(2400.0 * units.rpm, 28.7 * units.deg)
        .add_sample(2666.7 * units.rpm, 29.4 * units.deg)
        .add_sample(2933.3 * units.rpm, 29.9 * units.deg)
        .add_sample(3200.0 * units.rpm, 30.0 * units.deg)
        .add_sample(3466.7 * units.rpm, 30.0 * units.deg)
        .add_sample(3733.3 * units.rpm, 30.0 * units.deg)
        .add_sample(4000.0 * units.rpm, 30.0 * units.deg)
        .add_sample(4266.7 * units.rpm, -15.0 * units.deg)
        .add_sample(4533.3 * units.rpm, -45.0 * units.deg)

    engine.add_ignition_module(engine_config.ignition)
}

// Cord 810
public node veh {
    alias output __out: vehicle;
    vehicle vehicle(
        mass:  1860 * units.kg,
        drag_coefficient: 0.42,
        cross_sectional_area: (1803 * units.mm) * (1524 * units.mm),
        diff_ratio: 4.7,
        tire_radius: (724.0 / 2) * units.mm, // 6.50 x 16
        rolling_resistance: 20
        )
}

// Cord 812
private node trn {
    alias output __out:
        transmission(
            max_clutch_torque: 400 * units.Nm,
            max_clutch_flex: 10 * units.deg,
            limit_clutch_flex: true,
            clutch_stiffness: 20 * units.Nm / units.deg,
            clutch_damping: 2.0,
            simulate_flex: true
        )
        .add_gear(2.111)
        .add_gear(1.360)
        .add_gear(0.903)
        .add_gear(0.639);
}

run(
    engine: eng(),
    transmission: trn(),
    vehicle: veh()
)
